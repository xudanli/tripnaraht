# æ–°å¢æ¥å£å®ç°çŠ¶æ€

## P0 å¿…é¡»è¡¥çš„æ¥å£ï¼ˆä¸è¡¥ä¼šå¡ UI/é—­ç¯ï¼‰

### âœ… 1. Place è¯¦æƒ… & æ‰¹é‡æ‹‰å–
- **æ¥å£**: `GET /places/:id` - è·å–åœ°ç‚¹è¯¦æƒ…
- **æ¥å£**: `POST /places/batch` - æ‰¹é‡è·å–åœ°ç‚¹è¯¦æƒ…
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/places/places.service.ts` (findOne, findBatch)
  - Controller: `src/places/places.controller.ts`

### âœ… 2. å…³é”®è¯æœç´¢ / è‡ªåŠ¨è¡¥å…¨
- **æ¥å£**: `GET /places/search` - å…³é”®è¯æœç´¢åœ°ç‚¹
- **æ¥å£**: `GET /places/autocomplete` - åœ°ç‚¹åç§°è‡ªåŠ¨è¡¥å…¨
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/places/places.service.ts` (search, autocomplete)
  - Controller: `src/places/places.controller.ts`

### âœ… 3. è¡Œç¨‹"å½“å‰çŠ¶æ€"æ¥å£
- **æ¥å£**: `GET /trips/:id/state?now=ISO` - è·å–è¡Œç¨‹å½“å‰çŠ¶æ€
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/trips/trips.service.ts` (getTripState)
  - Controller: `src/trips/trips.controller.ts`

### âœ… 4. Schedule è¯»å†™æ¥å£
- **æ¥å£**: `GET /trips/:id/schedule?date=YYYY-MM-DD` - è·å– Schedule
- **æ¥å£**: `PUT /trips/:id/schedule?date=YYYY-MM-DD` - ä¿å­˜ Schedule
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/trips/trips.service.ts` (getSchedule, saveSchedule)
  - Service: `src/trips/services/schedule-converter.service.ts` (Schedule è½¬æ¢)
  - Controller: `src/trips/trips.controller.ts`

### â³ 5. Action é¢„æ¼”ï¼ˆdry-runï¼‰
- **æ¥å£**: `POST /schedule/preview-action` - é¢„è§ˆåŠ¨ä½œï¼Œä¸å®é™…æ‰§è¡Œ
- **çŠ¶æ€**: â³ å¾…å®ç°
- **è¯´æ˜**: éœ€è¦åœ¨ `src/schedule-action/schedule-action.service.ts` ä¸­æ·»åŠ  preview æ–¹æ³•

### â³ 6. Vision èƒ½åŠ›æŸ¥è¯¢
- **æ¥å£**: `GET /vision/capabilities` - æŸ¥è¯¢ Vision æœåŠ¡èƒ½åŠ›
- **çŠ¶æ€**: â³ å¾…å®ç°
- **è¯´æ˜**: éœ€è¦åœ¨ `src/vision/vision.controller.ts` ä¸­æ·»åŠ æ¥å£

---

## P1 å¼ºçƒˆå»ºè®®è¡¥çš„æ¥å£

### âœ… 7. è¯­éŸ³è½¬å†™ä¸ TTS
- **æ¥å£**: `POST /voice/transcribe` - éŸ³é¢‘è½¬æ–‡å­—
- **æ¥å£**: `POST /voice/speak` - æ–‡å­—è½¬è¯­éŸ³
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/voice/voice.service.ts` (transcribe, speak)
  - Controller: `src/voice/voice.controller.ts`
  - Providers: `src/providers/asr/`, `src/providers/tts/`

### âœ… 8. What-If æ‹†åˆ†æ¥å£
- **æ¥å£**: `POST /planning-policy/robustness/evaluate-day` - ä»…è¯„ä¼° base æŒ‡æ ‡
- **æ¥å£**: `POST /planning-policy/what-if/generate-candidates` - åªç”Ÿæˆå€™é€‰æ–¹æ¡ˆ
- **æ¥å£**: `POST /planning-policy/what-if/evaluate-candidates` - è¯„ä¼°å€™é€‰æ–¹æ¡ˆ
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Controller: `src/planning-policy/planning-policy.controller.ts`

### âœ… 9. æ“ä½œå†å² / æ’¤é”€
- **æ¥å£**: `GET /trips/:id/actions?date=...` - è·å–æ“ä½œå†å²
- **æ¥å£**: `POST /trips/:id/actions/undo` - æ’¤é”€æ“ä½œ
- **æ¥å£**: `POST /trips/:id/actions/redo` - é‡åšæ“ä½œ
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Service: `src/trips/services/action-history.service.ts`
  - Service: `src/trips/trips.service.ts` (getActionHistory, undoAction, redoAction)
  - Controller: `src/trips/trips.controller.ts`

### âœ… 10. ç³»ç»Ÿèƒ½åŠ›/çŠ¶æ€
- **æ¥å£**: `GET /system/status` - è·å–ç³»ç»ŸçŠ¶æ€
- **çŠ¶æ€**: âœ… å·²å®ç°
- **ä½ç½®**: 
  - Module: `src/system/system.module.ts`
  - Service: `src/system/system.service.ts`
  - Controller: `src/system/system.controller.ts`

---

## å“åº”æ ¼å¼ç»Ÿä¸€

### âœ… å·²ç»Ÿä¸€
- **æ‰€æœ‰æ–°å¢æ¥å£**éƒ½ä½¿ç”¨ `success/data/error` æ ¼å¼
- ä½¿ç”¨ `successResponse` å’Œ `errorResponse` è¾…åŠ©å‡½æ•°

### âœ… å·²ç»Ÿä¸€çš„ä¸»è¦æ¥å£
- **trips.controller.ts**: `create`, `findAll`, `findOne` ä»¥åŠæ‰€æœ‰æ–°å¢æ¥å£
- **countries.controller.ts**: `findAll`, `getCurrencyStrategy`
- **itinerary-optimization.controller.ts**: `optimize`
- **transport.controller.ts**: `plan`
- **places.controller.ts**: `getNearby`, `getNearbyRestaurants`, `createPlace` ä»¥åŠæ‰€æœ‰æ–°å¢æ¥å£ï¼ˆ`findOne`, `findBatch`, `search`, `autocomplete`ï¼‰
- **schedule-action.controller.ts**: `apply-action`, `preview-action`ï¼ˆå·²ç»Ÿä¸€ï¼‰
- **vision.controller.ts**: `poi-recommend`, `capabilities`ï¼ˆå·²ç»Ÿä¸€ï¼‰
- **planning-policy.controller.ts**: æ‰€æœ‰æ–°å¢æ¥å£ï¼ˆ`robustness/evaluate-day`, `what-if/generate-candidates`, `what-if/evaluate-candidates`ï¼‰

### âœ… å·²ç»Ÿä¸€æ‰€æœ‰ä¸»è¦æ¥å£
- **trips.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€ï¼ˆ`create`, `findAll`, `findOne` åŠæ‰€æœ‰æ–°å¢æ¥å£ï¼‰
- **places.controller.ts**: âœ… ä¸»è¦æ¥å£å·²ç»Ÿä¸€ï¼ˆ`getNearby`, `getNearbyRestaurants`, `createPlace` åŠæ‰€æœ‰æ–°å¢æ¥å£ï¼‰
- **countries.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **itinerary-optimization.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **transport.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **itinerary-items.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **hotels.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **flight-prices.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **schedule-action.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **vision.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€
- **planning-policy.controller.ts**: âœ… å…¨éƒ¨ç»Ÿä¸€ï¼ˆåŒ…æ‹¬ `what-if/evaluate`, `what-if/apply` ç­‰ï¼‰

**è¯´æ˜**: æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡æ¥å£å’Œä¸»è¦è¾…åŠ©æ¥å£å·²å…¨éƒ¨ç»Ÿä¸€ä¸º `success/data/error` æ ¼å¼ã€‚å‰ç«¯å¯ä»¥ç»Ÿä¸€å¤„ç†æ‰€æœ‰ API å“åº”ã€‚

---

## Trip / Schedule / DayScheduleResult è¾¹ç•Œè¯´æ˜

### æ•°æ®åº“è§†å›¾ï¼ˆæŒä¹…åŒ–ï¼‰
- **Trip**: è¡Œç¨‹ä¸»è¡¨
- **TripDay**: è¡Œç¨‹æ—¥æœŸè¡¨
- **ItineraryItem**: è¡Œç¨‹é¡¹è¡¨ï¼ˆæ´»åŠ¨ã€ç”¨é¤ã€ä¼‘æ¯ã€äº¤é€šç­‰ï¼‰

### ç®—æ³•è§†å›¾ï¼ˆå†…å­˜ç»“æ„ï¼‰
- **DayScheduleResult**: æ—¥ç¨‹æ’ç¨‹ç»“æœï¼ˆåŒ…å« stops å’Œ metricsï¼‰
- **PlannedStop**: è®¡åˆ’ç«™ç‚¹ï¼ˆPOIã€ä¼‘æ¯ã€ç”¨é¤ç­‰ï¼‰

### è½¬æ¢å…³ç³»
- **Schedule â†’ ItineraryItem**: é€šè¿‡ `ScheduleConverterService.saveScheduleToDatabase` è½¬æ¢
- **ItineraryItem â†’ Schedule**: é€šè¿‡ `ScheduleConverterService.loadScheduleFromDatabase` è½¬æ¢

### æ¥å£è¯´æ˜
- `GET /trips/:id`: è¿”å›æ•°æ®åº“è§†å›¾ï¼ˆTrip + TripDay + ItineraryItemï¼‰
- `GET /trips/:id/schedule`: è¿”å›ç®—æ³•è§†å›¾ï¼ˆDayScheduleResultï¼‰
- `PUT /trips/:id/schedule`: æ¥æ”¶ç®—æ³•è§†å›¾ï¼ˆDayScheduleResultï¼‰ï¼Œè½¬æ¢ä¸ºæ•°æ®åº“è§†å›¾ä¿å­˜

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… **å®ç° Action é¢„æ¼”æ¥å£** (P0-5) - å·²å®Œæˆ
2. âœ… **å®ç° Vision èƒ½åŠ›æŸ¥è¯¢æ¥å£** (P0-6) - å·²å®Œæˆ
3. âœ… **å®ç°è¯­éŸ³è½¬å†™å’Œ TTS** (P1-7) - å·²å®Œæˆ
4. âœ… **å®ç° What-If æ‹†åˆ†æ¥å£** (P1-8) - å·²å®Œæˆ
5. âœ… **å®ç°æ“ä½œå†å²å’Œæ’¤é”€** (P1-9) - å·²å®Œæˆ
6. âœ… **å®ç°ç³»ç»ŸçŠ¶æ€æ¥å£** (P1-10) - å·²å®Œæˆ
7. âœ… **æ›´æ–° API æ–‡æ¡£** - å·²å®Œæˆ
8. â³ **ç»Ÿä¸€ç°æœ‰æ¥å£çš„å“åº”æ ¼å¼** - å¾…å®Œæˆï¼ˆå»ºè®®åœ¨åç»­è¿­ä»£ä¸­é€æ­¥è¿ç§»ï¼‰

## æ€»ç»“

### âœ… å·²å®Œæˆï¼ˆ10ä¸ªæ¥å£ï¼‰
- **P0 å¿…é¡»è¡¥çš„æ¥å£**: 6ä¸ªï¼ˆå…¨éƒ¨å®Œæˆï¼‰
- **P1 å¼ºçƒˆå»ºè®®è¡¥çš„æ¥å£**: 4ä¸ªï¼ˆå…¨éƒ¨å®Œæˆï¼‰

### ğŸ“ æ–‡æ¡£æ›´æ–°
- âœ… æ›´æ–°äº† API æ¥å£æ–‡æ¡£ï¼Œæ·»åŠ äº†æ‰€æœ‰æ–°å¢æ¥å£çš„è¯´æ˜
- âœ… æ·»åŠ äº†æ•°æ®æ¨¡å‹è¾¹ç•Œè¯´æ˜ç« èŠ‚
- âœ… ç»Ÿä¸€å“åº”æ ¼å¼è¯´æ˜

### ğŸ”§ æŠ€æœ¯å®ç°
- âœ… åˆ›å»ºäº† ScheduleConverterService å¤„ç† Schedule å’Œ ItineraryItem çš„è½¬æ¢
- âœ… åˆ›å»ºäº† ActionHistoryService ç®¡ç†æ“ä½œå†å²
- âœ… åˆ›å»ºäº† SystemModule æä¾›ç³»ç»ŸçŠ¶æ€æŸ¥è¯¢
- âœ… åˆ›å»ºäº† ASR å’Œ TTS Provider æ¥å£ï¼ˆæ”¯æŒå¯æ’æ‹”ï¼‰

### âš ï¸ æ³¨æ„äº‹é¡¹
1. **æ“ä½œå†å²å­˜å‚¨**: å½“å‰å®ç°ä½¿ç”¨ Trip.metadata å­˜å‚¨æ“ä½œå†å²ï¼Œå»ºè®®åç»­åˆ›å»ºç‹¬ç«‹çš„ ActionHistory è¡¨
2. **å“åº”æ ¼å¼ç»Ÿä¸€**: æ‰€æœ‰æ–°å¢æ¥å£éƒ½ä½¿ç”¨ç»Ÿä¸€æ ¼å¼ï¼Œä½†ç°æœ‰æ¥å£éœ€è¦é€æ­¥è¿ç§»
3. **Provider å®ç°**: ASR å’Œ TTS ç›®å‰ä½¿ç”¨ Mock Providerï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚å®ç°çœŸå® Provider
