# äº¤é€šè§„åˆ’ API å®Œæ•´æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

äº¤é€šè§„åˆ’ API æä¾›æ™ºèƒ½è·¯çº¿è§„åˆ’åŠŸèƒ½ï¼Œæ”¯æŒï¼š
- **å›½å†…è·¯çº¿**ï¼šè‡ªåŠ¨ä½¿ç”¨é«˜å¾·åœ°å›¾ API
- **æµ·å¤–è·¯çº¿**ï¼šè‡ªåŠ¨ä½¿ç”¨ Google Routes API
- **æ™ºèƒ½æ¨è**ï¼šæ ¹æ®ç”¨æˆ·ç”»åƒï¼ˆè¡Œæã€è€äººã€å¤©æ°”ç­‰ï¼‰æ¨èæœ€ä½³äº¤é€šæ–¹å¼
- **å¤šæ¨¡å¼æ”¯æŒ**ï¼šæ­¥è¡Œã€å…¬å…±äº¤é€šã€æ‰“è½¦ã€é“è·¯ã€é£æœºç­‰

## ğŸ”— åŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:3000`
- **Swagger UI**: `http://localhost:3000/api` (å¯åŠ¨åè®¿é—®)
- **API ç‰ˆæœ¬**: 1.0

---

## ğŸš€ API æ¥å£

### 1. POST /transport/plan

è§„åˆ’äº¤é€šè·¯çº¿ï¼ˆæ™ºèƒ½æ¨èï¼‰

**åŠŸèƒ½**ï¼š
- æ ¹æ®èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œæ™ºèƒ½æ¨èæœ€ä½³äº¤é€šæ–¹å¼
- è‡ªåŠ¨åŒºåˆ†å¤§äº¤é€šï¼ˆåŸå¸‚é—´ï¼‰å’Œå°äº¤é€šï¼ˆå¸‚å†…ï¼‰
- æ ¹æ®ç”¨æˆ·ç”»åƒï¼ˆè¡Œæã€è€äººã€å¤©æ°”ç­‰ï¼‰æ™ºèƒ½æ’åº
- è®¡ç®—"ç—›è‹¦æŒ‡æ•°"ï¼Œæ¨èæœ€èˆ’é€‚çš„æ–¹æ¡ˆ

**è¯·æ±‚è·¯å¾„**: `POST /transport/plan`

**è¯·æ±‚å¤´**:
```
Content-Type: application/json
```

**è¯·æ±‚ä½“**:

```typescript
{
  // å¿…å¡«å­—æ®µ
  fromLat: number;      // èµ·ç‚¹çº¬åº¦
  fromLng: number;      // èµ·ç‚¹ç»åº¦
  toLat: number;        // ç»ˆç‚¹çº¬åº¦
  toLng: number;        // ç»ˆç‚¹ç»åº¦
  
  // å¯é€‰å­—æ®µ
  hasLuggage?: boolean;           // æ˜¯å¦å¸¦ç€è¡Œæç§»åŠ¨ï¼ˆå¦‚ï¼šæ¢é…’åº—æ—¥ï¼‰
  hasElderly?: boolean;            // æ˜¯å¦æœ‰è€äººåŒè¡Œ
  isRaining?: boolean;             // æ˜¯å¦æ­£åœ¨ä¸‹é›¨
  budgetSensitivity?: 'LOW' | 'MEDIUM' | 'HIGH';  // é¢„ç®—æ•æ„Ÿåº¦
  timeSensitivity?: 'LOW' | 'MEDIUM' | 'HIGH';    // æ—¶é—´æ•æ„Ÿåº¦
  hasLimitedMobility?: boolean;   // æ˜¯å¦æœ‰è¡ŒåŠ¨ä¸ä¾¿æˆå‘˜
  currentCity?: string;           // å½“å‰åŸå¸‚ä»£ç ï¼ˆç”¨äºåˆ¤æ–­æ˜¯å¦æ¢é…’åº—æ—¥ï¼‰
  targetCity?: string;            // ç›®æ ‡åŸå¸‚ä»£ç 
  isMovingDay?: boolean;          // æ˜¯å¦ä¸ºæ¢é…’åº—æ—¥
}
```

**è¯·æ±‚ç¤ºä¾‹**:

#### ç¤ºä¾‹ 1: å¸‚å†…äº¤é€šï¼ˆæ­£å¸¸æƒ…å†µï¼‰

```json
{
  "fromLat": 35.6762,
  "fromLng": 139.6503,
  "toLat": 35.6812,
  "toLng": 139.7671,
  "hasLuggage": false,
  "hasElderly": false,
  "isRaining": false,
  "budgetSensitivity": "MEDIUM"
}
```

#### ç¤ºä¾‹ 2: åŸå¸‚é—´äº¤é€šï¼ˆå¤§äº¤é€šï¼‰

```json
{
  "fromLat": 35.6762,
  "fromLng": 139.6503,
  "toLat": 34.6937,
  "toLng": 135.5023,
  "hasLuggage": true,
  "isMovingDay": true,
  "budgetSensitivity": "HIGH",
  "timeSensitivity": "MEDIUM"
}
```

#### ç¤ºä¾‹ 3: æœ‰è€äººåŒè¡Œ

```json
{
  "fromLat": 35.6762,
  "fromLng": 139.6503,
  "toLat": 35.6812,
  "toLng": 139.7671,
  "hasElderly": true,
  "isRaining": true,
  "budgetSensitivity": "LOW"
}
```

**å“åº”ä½“**:

```typescript
{
  options: Array<{
    mode: 'WALKING' | 'TRANSIT' | 'TAXI' | 'RAIL' | 'BUS' | 'FLIGHT';
    durationMinutes: number;      // é¢„è®¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    cost: number;                  // è´¹ç”¨ï¼ˆåˆ†ï¼Œéœ€è¦é™¤ä»¥100è½¬æ¢ä¸ºå…ƒï¼‰
    walkDistance: number;          // æ­¥è¡Œè·ç¦»ï¼ˆç±³ï¼‰
    transfers?: number;             // æ¢ä¹˜æ¬¡æ•°ï¼ˆä»…å…¬å…±äº¤é€šï¼‰
    score?: number;                 // ç—›è‹¦æŒ‡æ•°ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
    recommendationReason?: string;  // æ¨èç†ç”±
    warnings?: string[];            // è­¦å‘Šä¿¡æ¯
    description?: string;           // è¯¦ç»†æè¿°
  }>;
  recommendationReason: string;     // æ€»ä½“æ¨èç†ç”±
  specialAdvice?: string[];        // ç‰¹æ®Šå»ºè®®
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "options": [
    {
      "mode": "TAXI",
      "durationMinutes": 15,
      "cost": 1200,
      "walkDistance": 0,
      "score": 150,
      "recommendationReason": "é€‚åˆæºå¸¦è¡Œæã€é¿å…æ·‹é›¨",
      "warnings": [],
      "description": "æ‰“è½¦ï¼šé—¨åˆ°é—¨ï¼Œæœ€æ–¹ä¾¿"
    },
    {
      "mode": "TRANSIT",
      "durationMinutes": 35,
      "cost": 420,
      "walkDistance": 800,
      "transfers": 1,
      "score": 600,
      "recommendationReason": "ç»æµå®æƒ ",
      "warnings": [
        "éœ€è¦æ¢ä¹˜ 1 æ¬¡",
        "éœ€è¦æ­¥è¡Œ 800 ç±³åˆ°è½¦ç«™"
      ],
      "description": "å…¬å…±äº¤é€šï¼šéœ€è¦æ¢ä¹˜ 1 æ¬¡"
    }
  ],
  "recommendationReason": "æ‚¨å¸¦ç€è¡Œæï¼Œä¸”å¤–é¢æ­£åœ¨ä¸‹é›¨ï¼Œå»ºè®®æ‰“è½¦å‡ºè¡Œ",
  "specialAdvice": [
    "ğŸ’¡ å»ºè®®ä½¿ç”¨å®…æ€¥ä¾¿ï¼ˆYamatoï¼‰å°†è¡Œæç›´æ¥å¯„åˆ°ä¸‹ä¸€å®¶é…’åº—ï¼Œä»Šæ—¥è½»è£…æ¸¸ç©"
  ]
}
```

**çŠ¶æ€ç **:
- `200 OK`: æˆåŠŸè¿”å›äº¤é€šæ¨è
- `400 Bad Request`: è¯·æ±‚å‚æ•°é”™è¯¯
- `500 Internal Server Error`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å¸‚å†…çŸ­è·ç¦»ï¼ˆæ­¥è¡Œæ¨èï¼‰

```bash
curl -X POST http://localhost:3000/transport/plan \
  -H "Content-Type: application/json" \
  -d '{
    "fromLat": 35.6762,
    "fromLng": 139.6503,
    "toLat": 35.6812,
    "toLng": 139.7671,
    "hasLuggage": false,
    "hasElderly": false,
    "isRaining": false
  }'
```

**é¢„æœŸç»“æœ**: æ¨èæ­¥è¡Œï¼ˆå¦‚æœè·ç¦» < 1.5km ä¸”å¤©æ°”å¥½ï¼‰

### åœºæ™¯ 2: å¸‚å†…é•¿è·ç¦»ï¼ˆå…¬å…±äº¤é€šæ¨èï¼‰

```bash
curl -X POST http://localhost:3000/transport/plan \
  -H "Content-Type: application/json" \
  -d '{
    "fromLat": 35.6762,
    "fromLng": 139.6503,
    "toLat": 35.6812,
    "toLng": 139.7671,
    "hasLuggage": false,
    "budgetSensitivity": "HIGH"
  }'
```

**é¢„æœŸç»“æœ**: æ¨èå…¬å…±äº¤é€šï¼ˆç»æµå®æƒ ï¼‰

### åœºæ™¯ 3: æ¢é…’åº—æ—¥ï¼ˆæ‰“è½¦æ¨èï¼‰

```bash
curl -X POST http://localhost:3000/transport/plan \
  -H "Content-Type: application/json" \
  -d '{
    "fromLat": 35.6762,
    "fromLng": 139.6503,
    "toLat": 35.6812,
    "toLng": 139.7671,
    "hasLuggage": true,
    "isMovingDay": true
  }'
```

**é¢„æœŸç»“æœ**: æ¨èæ‰“è½¦ï¼ˆé—¨åˆ°é—¨ï¼Œé€‚åˆæºå¸¦è¡Œæï¼‰

### åœºæ™¯ 4: æœ‰è€äººåŒè¡Œï¼ˆå°‘æ­¥è¡Œæ¨èï¼‰

```bash
curl -X POST http://localhost:3000/transport/plan \
  -H "Content-Type: application/json" \
  -d '{
    "fromLat": 35.6762,
    "fromLng": 139.6503,
    "toLat": 35.6812,
    "toLng": 139.7671,
    "hasElderly": true,
    "isRaining": true
  }'
```

**é¢„æœŸç»“æœ**: æ¨èæ‰“è½¦ï¼ˆé¿å…æ­¥è¡Œå’Œæ¢ä¹˜ï¼‰

---

## ğŸ—ºï¸ æ™ºèƒ½ API é€‰æ‹©

ç³»ç»Ÿä¼šæ ¹æ®èµ·ç‚¹å’Œç»ˆç‚¹çš„åœ°ç†ä½ç½®è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„åœ°å›¾ APIï¼š

### å›½å†…è·¯çº¿ï¼ˆè‡ªåŠ¨ä½¿ç”¨é«˜å¾·åœ°å›¾ï¼‰

```json
{
  "fromLat": 39.9042,  // åŒ—äº¬
  "fromLng": 116.4074,
  "toLat": 31.2304,    // ä¸Šæµ·
  "toLng": 121.4737
}
```

â†’ **è‡ªåŠ¨ä½¿ç”¨é«˜å¾·åœ°å›¾ API**

### æµ·å¤–è·¯çº¿ï¼ˆè‡ªåŠ¨ä½¿ç”¨ Google Routesï¼‰

```json
{
  "fromLat": 35.6762,  // ä¸œäº¬
  "fromLng": 139.6503,
  "toLat": 34.6937,    // å¤§é˜ª
  "toLng": 135.5023
}
```

â†’ **è‡ªåŠ¨ä½¿ç”¨ Google Routes API**

### è·¨åŒºåŸŸè·¯çº¿ï¼ˆä½¿ç”¨ Google Routesï¼‰

```json
{
  "fromLat": 39.9042,  // åŒ—äº¬
  "fromLng": 116.4074,
  "toLat": 37.5665,   // é¦–å°”
  "toLng": 126.9780
}
```

â†’ **ä½¿ç”¨ Google Routes APIï¼ˆé™çº§ç­–ç•¥ï¼‰**

---

## ğŸ“Š äº¤é€šæ¨¡å¼è¯´æ˜

### WALKINGï¼ˆæ­¥è¡Œï¼‰
- **é€‚ç”¨åœºæ™¯**: è·ç¦» < 1.5kmï¼Œå¤©æ°”å¥½ï¼Œæ— è€äººï¼Œæ— è¡Œæ
- **è´¹ç”¨**: 0 å…ƒ
- **ç‰¹ç‚¹**: å…è´¹ï¼Œä½†å—å¤©æ°”å’Œä½“åŠ›é™åˆ¶

### TRANSITï¼ˆå…¬å…±äº¤é€šï¼‰
- **é€‚ç”¨åœºæ™¯**: è·ç¦» > 1.5kmï¼Œæ— å¤§ä»¶è¡Œæ
- **è´¹ç”¨**: æ ¹æ®è·ç¦»è®¡ç®—ï¼ˆé€šå¸¸ 3-10 å…ƒï¼‰
- **ç‰¹ç‚¹**: ç»æµå®æƒ ï¼Œä½†å¯èƒ½éœ€è¦æ¢ä¹˜å’Œæ­¥è¡Œ

### TAXIï¼ˆæ‰“è½¦ï¼‰
- **é€‚ç”¨åœºæ™¯**: æœ‰è¡Œæã€æœ‰è€äººã€ä¸‹é›¨ã€æ¢é…’åº—æ—¥
- **è´¹ç”¨**: èµ·æ­¥ä»· + é‡Œç¨‹è´¹ï¼ˆé€šå¸¸ 15-50 å…ƒï¼‰
- **ç‰¹ç‚¹**: é—¨åˆ°é—¨ï¼Œæœ€æ–¹ä¾¿ï¼Œä½†è´¹ç”¨è¾ƒé«˜

### RAILï¼ˆé“è·¯/é«˜é“ï¼‰
- **é€‚ç”¨åœºæ™¯**: åŸå¸‚é—´äº¤é€šï¼ˆ> 50kmï¼‰
- **è´¹ç”¨**: æ ¹æ®è·ç¦»è®¡ç®—ï¼ˆé€šå¸¸ 50-500 å…ƒï¼‰
- **ç‰¹ç‚¹**: å‡†æ—¶ï¼Œå¸‚ä¸­å¿ƒå¯¹å¸‚ä¸­å¿ƒ

### BUSï¼ˆé•¿é€”å·´å£«ï¼‰
- **é€‚ç”¨åœºæ™¯**: åŸå¸‚é—´äº¤é€šï¼Œé¢„ç®—æ•æ„Ÿ
- **è´¹ç”¨**: æ¯”é“è·¯ä¾¿å®œï¼ˆé€šå¸¸ 30-200 å…ƒï¼‰
- **ç‰¹ç‚¹**: ç»æµå®æƒ ï¼Œä½†æ—¶é—´è¾ƒé•¿

### FLIGHTï¼ˆé£æœºï¼‰
- **é€‚ç”¨åœºæ™¯**: åŸå¸‚é—´äº¤é€šï¼Œæ—¶é—´æ•æ„Ÿï¼Œè·ç¦» > 500km
- **è´¹ç”¨**: æ ¹æ®èˆªçº¿è®¡ç®—ï¼ˆé€šå¸¸ 500-2000 å…ƒï¼‰
- **ç‰¹ç‚¹**: æœ€å¿«ï¼Œä½†éœ€è¦æå‰åˆ°æœºåœº

---

## ğŸ”§ é…ç½®è¦æ±‚

### ç¯å¢ƒå˜é‡

```env
# é«˜å¾·åœ°å›¾ APIï¼ˆå›½å†…å¿…éœ€ï¼‰
AMAP_API_KEY=your_amap_api_key

# Google Routes APIï¼ˆæµ·å¤–å¿…éœ€ï¼Œå›½å†…é™çº§ä½¿ç”¨ï¼‰
GOOGLE_ROUTES_API_KEY=your_google_api_key

# Redis é…ç½®ï¼ˆç¼“å­˜è·¯çº¿æ•°æ®ï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
REDIS_TTL=3600
```

### è·å– API Key

**é«˜å¾·åœ°å›¾**:
1. è®¿é—® https://console.amap.com/
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. åˆ›å»ºåº”ç”¨ï¼Œè·å– Web æœåŠ¡ API Key

**Google Maps**:
1. è®¿é—® https://console.cloud.google.com/
2. åˆ›å»ºé¡¹ç›®
3. å¯ç”¨ Routes API
4. åˆ›å»º API Key

---

## ğŸ“ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯

#### 1. API Key æœªé…ç½®

**é”™è¯¯ä¿¡æ¯**: `é«˜å¾·åœ°å›¾ API Key æœªé…ç½®ï¼Œä½¿ç”¨ä¼°ç®—æ•°æ®`

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½® `AMAP_API_KEY` æˆ– `GOOGLE_ROUTES_API_KEY`

#### 2. API è°ƒç”¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: `é«˜å¾·åœ°å›¾ API è°ƒç”¨å¤±è´¥: ...`

**è§£å†³æ–¹æ¡ˆ**: 
- æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥ API é…é¢æ˜¯å¦ç”¨å®Œ
- ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§ä½¿ç”¨ä¼°ç®—æ•°æ®

#### 3. å‚æ•°é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: `Validation failed`

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼å’Œç±»å‹

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# æµ‹è¯•å¸‚å†…äº¤é€š
curl -X POST http://localhost:3000/transport/plan \
  -H "Content-Type: application/json" \
  -d '{
    "fromLat": 35.6762,
    "fromLng": 139.6503,
    "toLat": 35.6812,
    "toLng": 139.7671,
    "hasLuggage": false,
    "hasElderly": false,
    "isRaining": false
  }' | jq
```

### ä½¿ç”¨ Postman

1. åˆ›å»ºæ–°è¯·æ±‚
2. æ–¹æ³•: `POST`
3. URL: `http://localhost:3000/transport/plan`
4. Headers: `Content-Type: application/json`
5. Body: é€‰æ‹© `raw` â†’ `JSON`ï¼Œç²˜è´´è¯·æ±‚ç¤ºä¾‹

### ä½¿ç”¨ Swagger UI

1. å¯åŠ¨æœåŠ¡: `npm run backend:dev`
2. è®¿é—®: `http://localhost:3000/api`
3. æ‰¾åˆ° `transport` æ ‡ç­¾
4. ç‚¹å‡» `POST /transport/plan`
5. ç‚¹å‡» "Try it out"
6. å¡«å†™è¯·æ±‚å‚æ•°
7. ç‚¹å‡» "Execute"

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æ—¥å¿—

æœåŠ¡ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼š

```
[TransportRoutingService] ä½¿ç”¨é«˜å¾·åœ°å›¾ APIï¼ˆå›½å†…è·¯çº¿ï¼‰
[SmartRoutesService] ä½¿ç”¨é«˜å¾·åœ°å›¾ APIï¼ˆå›½å†…è·¯çº¿ï¼‰
[RouteCacheService] ç¼“å­˜å‘½ä¸­: route:35.6762,139.6503_35.6812,139.7671_TRANSIT
```

### 2. æ£€æŸ¥ç¼“å­˜

```bash
# ä½¿ç”¨ redis-cli æŸ¥çœ‹ç¼“å­˜
redis-cli
> KEYS route:*
> GET route:35.6762,139.6503_35.6812,139.7671_TRANSIT
```

### 3. éªŒè¯ API é€‰æ‹©

- å›½å†…åæ ‡ â†’ åº”è¯¥ä½¿ç”¨é«˜å¾·åœ°å›¾
- æµ·å¤–åæ ‡ â†’ åº”è¯¥ä½¿ç”¨ Google Routes
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ä½¿ç”¨çš„ API

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [äº¤é€šè§„åˆ’ç³»ç»Ÿè®¾è®¡](./TRANSPORT-PLANNING-SYSTEM.md)
- [æ™ºèƒ½è·¯çº¿è§„åˆ’ API ç­–ç•¥](./ROUTE-API-STRATEGY.md)
- [äº¤é€šè®¡ç®—ä¼˜åŒ–æ”¹è¿›](./TRANSPORT-OPTIMIZATION-IMPROVEMENTS.md)
- [Redis ç¼“å­˜è®¾ç½®](./REDIS-SETUP.md)
- [API å‚è€ƒæ–‡æ¡£](./API-REFERENCE.md)

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ç¼“å­˜ä¼˜å…ˆ**: ç³»ç»Ÿä¼šè‡ªåŠ¨ç¼“å­˜è·¯çº¿æ•°æ®ï¼Œå‡å°‘ API è°ƒç”¨
2. **é™çº§ç­–ç•¥**: API å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨è·ç¦»ä¼°ç®—ï¼Œä¿è¯ç³»ç»Ÿå¯ç”¨
3. **æ‰¹é‡è¯·æ±‚**: å¯¹äº TSP ä¼˜åŒ–ï¼Œç³»ç»Ÿä¼šæ‰¹é‡é¢„è®¡ç®—ï¼Œæé«˜æ€§èƒ½
4. **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®åœ°ç†ä½ç½®è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„ API

---

## ğŸ†˜ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- Swagger UI: `http://localhost:3000/api`
- æ—¥å¿—è¾“å‡º
- ç›¸å…³æ–‡æ¡£
