# 航班数据导入指南

## 概述

本指南说明如何将2024年中国航空航班历史数据（65MB CSV文件）导入数据库，并自动计算价格因子。

## 数据准备

### CSV 文件格式要求

文件必须包含以下列：
- `出发城市` - 出发城市名称（如：成都）
- `到达城市` - 到达城市名称（如：深圳）
- `日期` - 日期格式：`2024/1/1` 或 `2024-01-01`
- `价格(元)` 或 `价格元` - 价格（数字）

**示例数据：**
```csv
出发城市,到达城市,日期,价格(元)
成都,深圳,2024/1/1,2375
成都,深圳,2024/1/2,2400
北京,上海,2024/1/1,1200
```

## 导入步骤

### 1. 准备数据库表

确保数据库表已创建：

```bash
# 如果表不存在，需要运行迁移
npx prisma db push
```

### 2. 运行导入脚本

```bash
# 使用默认路径（项目根目录的 flight_data_2024.csv）
npm run import:flight-data

# 或指定文件路径
npm run import:flight-data /path/to/your/flight_data_2024.csv
```

### 3. 等待处理完成

脚本会：
1. 加载 CSV 文件（约 1-2 分钟）
2. 计算周内因子（约 1 分钟）
3. 计算月度基准价（约 2-3 分钟）
4. 批量写入数据库（约 5-10 分钟）

**总耗时：** 约 10-15 分钟（50万条记录）

## 处理流程详解

### 步骤 1：数据清洗

- 过滤无效数据（价格 <= 0 或 > 100000）
- 确保日期格式正确
- 确保城市名称不为空

### 步骤 2：计算星期几和月份

```typescript
// 星期几：0=周一, 6=周日
dayOfWeek = getDayOfWeek(dateStr)

// 月份：1-12
month = getMonth(dateStr)

// 航线ID
routeId = `${originCity}->${destinationCity}`
```

### 步骤 3：计算周内因子 (F_day)

**公式：**
```
F_day = 该星期几的平均价格 / 总平均价格
```

**示例：**
- 总平均价：2200 元
- 周五平均价：2530 元
- 周五因子：2530 / 2200 = 1.15

### 步骤 4：计算月度基准价 (P_month)

**公式：**
```
P_month = 该航线在该月的所有价格的平均值
```

**示例：**
- 成都->深圳，3月：1800 元
- 成都->深圳，8月：3200 元

### 步骤 5：计算详细数据

按 `航线-月份-星期几` 分组，计算：
- 平均价格
- 最低价格
- 最高价格
- 标准差
- 样本数量

## 数据验证

### 检查导入结果

```bash
# 检查周内因子
curl http://localhost:3000/flight-prices/day-of-week-factors

# 检查特定航线
curl "http://localhost:3000/flight-prices/domestic/estimate?originCity=成都&destinationCity=深圳&month=3"
```

### 预期结果

**周内因子：**
- 周一-周四：0.95 - 1.0（低于平均价）
- 周五-周日：1.1 - 1.2（高于平均价）

**月度基准价：**
- 1-2月（春节）：较高
- 3-5月（淡季）：较低
- 7-8月（暑假）：较高
- 9-11月（淡季）：较低
- 12月（寒假）：较高

## 故障排除

### 问题 1：内存不足

**症状：** 脚本运行缓慢或崩溃

**解决方案：**
- 增加 Node.js 内存限制：`NODE_OPTIONS="--max-old-space-size=4096" npm run import:flight-data`
- 分批处理：修改脚本，每次处理 10 万条记录

### 问题 2：CSV 列名不匹配

**症状：** 提示找不到列

**解决方案：**
- 检查 CSV 文件的第一行（列名）
- 确保列名包含：`出发城市`, `到达城市`, `日期`, `价格(元)` 或 `价格元`
- 可以修改脚本中的列名映射

### 问题 3：日期格式错误

**症状：** 日期解析失败

**解决方案：**
- 确保日期格式为：`2024/1/1` 或 `2024-01-01`
- 可以修改脚本中的日期解析逻辑

### 问题 4：数据库连接失败

**症状：** Prisma 连接错误

**解决方案：**
- 检查 `.env` 文件中的 `DATABASE_URL`
- 确保数据库服务正在运行
- 运行 `npx prisma db push` 创建表

## 性能优化

### 批量写入

脚本使用批量写入（每批 100 条），减少数据库交互次数。

### 内存优化

- 使用流式处理（如果文件太大）
- 指定数据类型，减少内存占用
- 及时释放不需要的数据

### 进度显示

脚本会显示处理进度：
```
进度: 1000 / 35000
进度: 2000 / 35000
```

## 数据更新

### 定期更新

建议每月更新一次历史数据：
1. 获取新的 CSV 文件
2. 运行导入脚本
3. 新数据会覆盖旧数据（基于 routeId + month + dayOfWeek）

### 增量更新

如果需要增量更新，可以：
1. 只导入新月份的数据
2. 使用 `--month` 参数过滤（需要修改脚本）

## 使用示例

### 示例 1：查询价格

```bash
# 查询成都到深圳，3月，周五的价格
curl "http://localhost:3000/flight-prices/domestic/estimate?originCity=成都&destinationCity=深圳&month=3&dayOfWeek=4"
```

**响应：**
```json
{
  "estimatedPrice": 2375,
  "lowerBound": 2138,
  "upperBound": 2613,
  "monthlyBasePrice": 2200,
  "dayOfWeekFactor": 1.08,
  "sampleCount": 45
}
```

### 示例 2：查看价格趋势

```bash
# 查看成都到深圳全年价格趋势
curl "http://localhost:3000/flight-prices/domestic/monthly-trend?originCity=成都&destinationCity=深圳"
```

**响应：**
```json
[
  { "month": 1, "basePrice": 2500, "sampleCount": 120 },
  { "month": 2, "basePrice": 3200, "sampleCount": 95 },
  { "month": 3, "basePrice": 1800, "sampleCount": 110 }
]
```

## 总结

通过导入历史数据，系统可以：
1. **精确估算**：基于真实历史数据，而非手动估算
2. **周内波动**：考虑周一到周日的价格差异
3. **季节性**：考虑1-12月的价格波动
4. **价格范围**：提供价格上下限，帮助预算规划

