# DEM 海拔查询服务测试用例文档

## 概述

本文档定义了全国DEM（Digital Elevation Model，数字高程模型）导入数据的测试用例和用户场景。

## 测试目标

1. **功能正确性**：验证DEM数据查询的准确性
2. **优先级机制**：验证城市DEM优先于区域DEM
3. **性能评估**：测试查询响应时间
4. **边界处理**：测试无数据、坐标超出范围等情况
5. **集成测试**：验证与POI服务的集成

---

## 测试场景

### 场景1：基础功能测试

**目标**：验证单个坐标点的海拔查询功能

**测试用例**：

| 测试点 | 坐标 (lat, lng) | 期望海拔范围 (m) | 数据源类型 |
|--------|----------------|------------------|-----------|
| 北京市天安门 | 39.9042, 116.4074 | 40-60 | 城市DEM |
| 上海市外滩 | 31.2304, 121.4737 | 0-20 | 城市DEM |
| 成都市天府广场 | 30.6624, 104.0633 | 480-520 | 城市DEM |
| 杭州市西湖 | 30.2741, 120.1551 | 0-50 | 城市DEM |
| 拉萨市布达拉宫 | 29.6544, 91.1322 | 3600-3700 | 城市DEM/区域DEM |
| 日喀则市 | 29.2675, 88.8801 | 3800-3900 | 区域DEM |
| 林芝市 | 29.6544, 94.3614 | 2900-3100 | 区域DEM |

**验证点**：
- ✅ 查询返回有效海拔值
- ✅ 海拔值在合理范围内
- ✅ 查询时间 < 500ms

---

### 场景2：城市DEM优先级测试

**目标**：验证当坐标同时属于城市DEM和区域DEM时，优先使用城市DEM（更精确）

**测试用例**：

1. **拉萨市测试**
   - 坐标：29.6544, 91.1322
   - 预期：优先使用 `geo_dem_city_拉萨` 表
   - 验证：查询结果应与城市DEM表一致

2. **其他有城市DEM的城市**
   - 测试所有已导入城市DEM的城市
   - 验证自动查找城市DEM表功能
   - 验证优先级机制

**验证点**：
- ✅ 自动识别包含坐标的城市DEM表
- ✅ 优先使用城市DEM数据
- ✅ 城市DEM无数据时回退到区域DEM

---

### 场景3：批量查询测试

**目标**：测试多个坐标点同时查询的性能和准确性

**测试用例**：

- 批量查询10个不同城市的坐标点
- 包含：主要城市、高海拔城市、西藏地区

**验证点**：
- ✅ 所有查询成功完成
- ✅ 平均查询时间 < 1000ms/点
- ✅ 结果准确性不受批量查询影响

---

### 场景4：边界情况测试

**目标**：测试各种边界情况和错误处理

**测试用例**：

| 场景 | 坐标 (lat, lng) | 期望结果 |
|------|----------------|---------|
| 超出DEM覆盖范围 | 0, 180 (太平洋) | 返回 null |
| 超出DEM覆盖范围 | 90, 0 (北极) | 返回 null |
| 无DEM数据区域 | 20, 100 | 返回 null |
| 无效坐标 | NaN, NaN | 抛出错误或返回 null |

**验证点**：
- ✅ 超出范围时返回 null（不抛异常）
- ✅ 无数据时返回 null（不抛异常）
- ✅ 错误处理优雅，不影响其他查询

---

### 场景5：DEM表状态检查

**目标**：验证DEM表的导入状态和元数据

**测试用例**：

1. **区域DEM检查**
   - 表名：`geo_dem_xizang`
   - 验证：表存在、有数据、边界范围正确

2. **城市DEM检查**
   - 统计城市DEM表数量
   - 验证表名格式正确
   - 验证表有数据

**验证点**：
- ✅ 区域DEM表存在
- ✅ 城市DEM表数量 > 0
- ✅ 所有DEM表边界范围合理

---

### 场景6：性能测试

**目标**：评估查询性能，确保满足生产环境要求

**测试用例**：

1. **单点查询性能**
   - 测试100个随机坐标点
   - 统计：平均时间、最大时间、最小时间

2. **批量查询性能**
   - 测试10、50、100个点的批量查询
   - 对比：批量查询 vs 逐个查询的效率

**性能指标**：
- 单点查询：平均 < 500ms，最大 < 2000ms
- 批量查询：平均 < 1000ms/点

---

### 场景7：集成测试

**目标**：验证DEM服务与POI服务的集成

**测试用例**：

1. **POI海拔补充**
   - 测试POI服务使用DEM数据补充海拔信息
   - 验证：POI的 `altitude_hint` 字段正确填充

2. **西藏旅行准备度检查**
   - 测试使用DEM数据计算平均海拔
   - 验证：`avgAltitudeM` 字段正确计算

**验证点**：
- ✅ POI服务正确调用DEM服务
- ✅ 海拔数据正确传递到准备度检查
- ✅ 无DEM数据时优雅降级

---

## 用户场景

### 场景A：旅行路线规划

**用户需求**：规划一条从成都到拉萨的自驾路线，需要了解沿途海拔变化

**测试步骤**：
1. 查询路线关键点的海拔
2. 计算海拔变化趋势
3. 识别高海拔路段（> 4000m）
4. 提供高海拔适应建议

**预期结果**：
- 准确显示沿途海拔
- 正确识别高海拔路段
- 提供合理的旅行建议

---

### 场景B：POI海拔信息补充

**用户需求**：查看西藏某个POI的详细信息，包括海拔

**测试步骤**：
1. 查询POI坐标
2. 从DEM数据获取海拔
3. 补充到POI信息中

**预期结果**：
- POI信息包含准确的海拔数据
- 优先使用城市DEM（更精确）
- 无数据时显示"未知"

---

### 场景C：批量地点海拔查询

**用户需求**：批量查询多个目的地的海拔，用于旅行准备

**测试步骤**：
1. 输入多个坐标点
2. 批量查询海拔
3. 返回结果列表

**预期结果**：
- 所有查询成功完成
- 响应时间合理
- 结果准确

---

## 测试执行

### 运行所有测试

```bash
npm run test:dem -- --all
```

### 测试指定城市

```bash
npm run test:dem -- --city "拉萨市"
```

### 仅检查DEM表状态

```bash
npm run test:dem
```

---

## 测试结果评估

### 通过标准

- ✅ 所有基础功能测试通过
- ✅ 城市DEM优先级正确
- ✅ 批量查询性能达标
- ✅ 边界情况处理正确
- ✅ 无异常抛出

### 失败处理

如果测试失败：
1. 检查DEM表是否正确导入
2. 验证数据库连接
3. 检查坐标范围是否在DEM覆盖范围内
4. 查看详细错误日志

---

## 持续改进

### 测试数据扩展

- 添加更多城市的测试用例
- 覆盖更多边界情况
- 增加性能压力测试

### 自动化测试

- 集成到CI/CD流程
- 定期运行回归测试
- 监控查询性能趋势

---

## 相关文档

- [DEM数据导入文档](../data/geographic/dem/china/README.md)
- [DEMElevationService API文档](../src/trips/readiness/services/dem-elevation.service.ts)
- [西藏POI集成文档](./XIZANG_POI_INTEGRATION.md)

