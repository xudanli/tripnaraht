
0. 全局约定（所有模块通用）
0.1 时间与时区

所有时间字段：ISO8601 + timezone（例如 2026-01-03T09:00:00+09:00）

行程内部计算统一使用：trip.timezone

UI 展示可用区间：ETA_min~ETA_max

可行性检查严禁使用 raw 地图 API 时长，必须使用 T_robust

0.2 鲁棒交通时间（T_robust）

T_robust = T_api * buffer_factor + fixed_buffer + last_mile_buffer + mode_switch_buffer + cross_zone_penalty

默认：

buffer_factor=1.15

fixed_buffer=5min

last_mile_buffer=15min

mode_switch_buffer=5~12min（按换乘次数）

cross_zone_penalty=0~15min（跨区/跨城）

返回结果允许同时返回：

t_api_min, t_robust_min, t_robust_range=[min,max]

0.3 优先级与锁定

priority: HARD (must) / SOFT (want)

lock: true/false（锁定的 item 在优化/修复中不得移动/删除，除非用户明确解锁）

1) 统一结构件（强烈建议先实现）
1.1 Violation（约束违规）
{
  "severity": "error|warning|info",
  "code": "TIMEWINDOW_MISS|CLOSED|DAY_BOUNDARY|BUDGET_EXCEEDED|ROBUST_INFEASIBLE|OVER_PACING|WEATHER_BLOCK|CONFLICT_OVERLAP",
  "item_id": "it_123",
  "related_item_id": "it_456",
  "anchor": {
    "type": "close_time|latest_entry|slack_shortage|day_boundary|weather_threshold",
    "value": "close_time=18:00; slack=8min"
  },
  "message": "到达时间 18:12 晚于关门 18:00",
  "suggestions": [
    { "type": "SHIFT_EARLIER|REDUCE_DURATION|MOVE_TO_OTHER_DAY|DROP_SOFT|REPLACE_INDOOR", "payload": {} }
  ]
}

1.2 DroppedItem（被丢弃的点）
{
  "item_id": "it_789",
  "reason_code": "TIMEWINDOW_CONFLICT|DAY_OVERFLOW|ROBUST_TRAVEL_TOO_LONG|PACING_LIMIT|BUDGET_LIMIT",
  "reason_text": "按鲁棒交通时间会迟到，且为 SOFT 节点",
  "conflict_snapshot": {
    "conflict_type": "close_time",
    "expected_arrival": "2026-01-03T18:12:00+09:00",
    "deadline": "2026-01-03T18:00:00+09:00",
    "delta_min": 12
  },
  "explain": {
    "one_liner": "为了保证你能在 18:00 前入场，我把它移出当天。",
    "anchors": ["18:00 关门", "鲁棒交通 +15min 缓冲"],
    "options": ["提前 30 分钟出发", "缩短上一站停留 20 分钟", "改到 Day2 上午"]
  }
}

1.3 Explain（解释结构，所有“为什么”统一用它）
{
  "summary": "今天按“紧凑”节奏安排，保留 2 个必去点并强制午餐块。",
  "reasons": [
    { "type": "TIMEWINDOW", "text": "浅草寺上午人少且 17:00 关闭" },
    { "type": "DISTANCE", "text": "把近的点放一起减少折返 3.2km" },
    { "type": "PREFERENCE", "text": "你偏好文化/慢节奏，所以增加了 30min 缓冲" }
  ],
  "decision_trace_id": "dl_001"
}

1.4 API 返回统一 Envelope（推荐）
{
  "success": true,
  "data": {},
  "meta": { "request_id": "req_xxx", "provider_status": {} },
  "errors": []
}

1.5 错误码（建议全局枚举）

400 参数：INVALID_ARGUMENT, MISSING_REQUIRED_FIELD

404：TRIP_NOT_FOUND, PLACE_NOT_FOUND, ITEM_NOT_FOUND

409 冲突：TIME_CONFLICT, LOCKED_ITEM_CONFLICT

422 不可行：SCHEDULE_INFEASIBLE

429：RATE_LIMITED

503：PROVIDER_UNAVAILABLE（地图/LLM/语音等）

2) 核心实体（最小必要表/对象）
2.1 Trip

id, user_id, destination, timezone, start_date, days, budget_total, budget_transport, budget_daily, style(relaxed/normal/intense), status(planning/on_trip/completed)

pacing_config（体力/步行阈值/海拔/风险偏好）

policy_config（最早出发/最晚结束/午餐窗口/缓冲策略）

2.2 TripDay

id, trip_id, date, day_index, day_start_time, day_end_time

2.3 ItineraryItem

id, trip_day_id, place_id(optional), type(sight/meal/transport/hotel/rest/free), start_time, end_time, duration_min

priority(HARD/SOFT), lock, notes

time_windows[]（多时间窗）

cost_estimate, walking_estimate, risk_flags[]

2.4 Place

id, name_zh/en/local, type, categories[], lat,lng, address, opening_hours(time_windows[]), rating, price_level

why_tokens[]（用于语义解释：评论标签/摘要）

2.5 TransportPlan / Leg

from_item_id, to_item_id, options[]

option：mode, t_api_min, t_robust_min, t_robust_range, cost_estimate, pain_index, steps[]

2.6 DecisionLog（决策层）

id, trip_id, strategy(abu/drdre/neptune), inputs_hash, outputs_hash

evidence[]（触发原因：天气/闭馆/迟到风险）

changes[]（改动明细：move/drop/replace）

explain（Explain 结构）

3) 模块规格（按 P0/P1 优先落地）

下面每个模块给：范围 → 接口 → 请求/响应要点 → 边界用例 → 埋点指标

3.1 Trips（P0）
范围

行程 CRUD、状态、分享导入、当前进度

不负责：日内排程（交给 Optimization/Decision），只存储与聚合展示

API

POST /trips 创建行程（Story 1.1）

req：

{
  "destination":"Tokyo",
  "timezone":"Asia/Tokyo",
  "start_date":"2026-01-03",
  "days":5,
  "budget_total":20000,
  "budget_transport":6000,
  "travelers":{"adults":2,"kids":1},
  "preferences":["culture","food"],
  "style":"normal"
}


resp：

{
  "trip_id":"t_001",
  "budget_daily":3500,
  "hotel_tier_reco":"3-4_star",
  "pacing_strategy":"normal",
  "next_action":"OPEN_TRIP_DETAIL"
}


GET /trips/:id 详情（Story 1.3）

resp：Trip + days + items（分页/按天）

GET /trips/:id/progress?now=... 当前活动与下一站（Story 1.4）

resp：

{
  "now":{"day_id":"d1","item_id":"it_03"},
  "next":{"item_id":"it_04","place_name":"浅草寺","eta":"2026-01-03T10:12:00+09:00","eta_range":[10,18]}
}


POST /trips/:id/recap 复盘生成（P2，可先 stub）

resp：统计 + 导出链接（或异步 job_id）

边界用例（测试点）

跨时区行程：now 判定必须用 trip.timezone

预算切分：budget_daily = (total - transport)/days，不足则给 warning

status 自动流转：planning → on_trip → completed（按日期/用户手动）

埋点/指标

trip_create_success_rate

trip_detail_load_ms

progress_query_count

recap_generate_success_rate

3.2 Places（P0+P1）
范围

关键词搜索、附近查询、自然 POI、语义搜索（向量）、地点解释字段输出

API

GET /places/search?q=东京塔&types=sight,food&lat=...&lng=...

resp：list + distance + opening snapshot

GET /places/nearby?lat=...&lng=...&radius_m=2000&types=...

强制 PostGIS 索引

GET /places/nature?lat=...&lng=...&subCategory=waterfall

resp：自然 POI 列表

POST /places/semantic-search（P1，Story 2.6）

req：

{
  "query":"像京都那样的地方",
  "locale":"zh",
  "center":{"lat":35.68,"lng":139.76},
  "mix":{"vector_weight":0.7,"keyword_weight":0.3},
  "limit":20
}


resp（关键：why_recommended）

{
  "results":[
    {
      "place_id":"p_123",
      "name_zh":"根津美术馆",
      "score":0.82,
      "why_recommended":[
        {"type":"review","text":"评论高频提到“静谧”“日式庭院”"},
        {"type":"tag","text":"garden / zen / quiet"}
      ]
    }
  ]
}

边界用例

无坐标：不返回 distance，但仍可关键词搜索

opening_hours 缺失：返回 opening_status=unknown + warning

语义搜索：embedding provider 不可用 → 降级到关键词

指标

place_search_latency_ms

semantic_search_hit_rate（相似度>0.7 的点击率）

why_view_rate

3.3 ItineraryItems（P0）
API

POST /trips/:id/items 添加活动（Story 3.1）

req：place_id + day_id + time preference

服务端必须做：

opening 校验

冲突检测

resp：item + violations(warning)

PATCH /items/:id 修改时间（Story 3.2）

支持拖拽：只改 start/end，触发 revalidate

冲突：

409 TIME_CONFLICT

或允许写入但返回 violations（看你产品策略；建议 P0 直接 409）

POST /trips/:id/items/meal（Story 3.3）

req：meal_type + anchor|floating

resp：插入的 meal block item

边界用例

多时间窗：item.time 必须落入任意一个 window，否则 422

lock item：PATCH 若试图移动锁定项，返回 409 LOCKED_ITEM_CONFLICT

指标

item_add_success_rate

time_conflict_rate

meal_insert_rate

3.4 Transport（P0）
API

POST /transport/plan（Story 5.1/5.3）

req：

{
  "from":{"lat":...,"lng":...,"time":"2026-01-03T10:00:00+09:00"},
  "to":{"lat":...,"lng":...},
  "context":{"has_luggage":true,"with_kids":true,"weather":"rain"},
  "modes":["walk","transit","taxi"]
}


resp：options[] + t_robust_range + pain_index + explain

GET /transport/provider-status

用于 System 模块展示

关键规则

pain_index（0~100）建议由：步行距离、换乘次数、天气、行李、拥挤估计组合

若地图 API 超时：返回 503 PROVIDER_UNAVAILABLE 或降级估算（建议 P0 直接 503 + 前端提示）

指标

transport_plan_latency_ms

provider_error_rate

avg_pain_index_shown

3.5 ItineraryOptimization（P0+P1）
范围

日内优化（P0）

必去想去+多时间窗+丢弃解释（P1）

多日拆解（P1/P2）

API

POST /optimize/day（P0：4.1/4.4）

req：

{
  "trip_id":"t_001",
  "day_id":"d1",
  "items":[{"item_id":"it1","priority":"HARD","lock":false}],
  "constraints":{
    "day_start":"09:00",
    "day_end":"21:00",
    "lunch_block":{"duration_min":60,"window":["11:30","13:30"]}
  },
  "preferences":{"style":"normal"}
}


resp：

{
  "schedule":{"items":[/*已排好 start/end */]},
  "summary":{"total_buffer_min":52,"waiting_min":12,"score":0.78},
  "dropped_items":[/*DroppedItem*/],
  "violations":[/*Violation*/],
  "explain":{/*Explain*/}
}


POST /optimize/multi-day（P1：4.7）

输入：30 点 + days

输出：Day1..DayN 分配 + 每日 schedule

必须输出：region_metrics 与 balance_metrics

关键规则落地（对应你故事）

软节点（SOFT）冲突可 drop，不报错

硬节点（HARD）冲突 → 422 SCHEDULE_INFEASIBLE + violations + suggestions

多时间窗：只允许命中其中一个 window（输出标注 selected_window）

测试用例（最少）

TC-DAY-01：午餐块必出现且落窗

TC-DAY-02：raw 可行但 robust 不可行 → 必须判定不可行（或 drop soft）

TC-DAY-03：hard 节点冲突 → 422 + 具体锚点解释

TC-MD-01/02/03：按你文档原样

指标

optimize_day_success_rate

avg_dropped_soft_count

robust_infeasible_rate

explain_open_rate

3.6 PlanningPolicy（P1）
API

POST /policy/evaluate（6.1）

输入：某天 schedule

输出：

{
  "risk":"low|medium|high",
  "total_buffer_minutes":44,
  "total_wait_minutes":18,
  "top3_min_slack_nodes":[{"item_id":"it5","slack_min":6}],
  "violations":[]
}


POST /policy/suggest（6.2）

输出候选建议列表（未评估）

POST /policy/whatif/run（6.3/6.4）

支持分步：step=base|candidates|evaluate|final

输出 winnerId + 对比 + 风险警告

POST /policy/apply（6.5）

将 winner schedule 写回 trip/day

指标

whatif_start_rate

whatif_apply_rate

winner_accept_rate

3.7 ScheduleAction（P0）

把“移动/添加/查询下一站”收敛到这里，Trips/Voice 只做入口。

API

POST /actions/preview（13.1）

req：action_type + payload

resp：diff + warnings + predicted schedule（不落库）

POST /actions/apply（13.2）

成功：落库并返回新 schedule

查询类动作：QUERY_NEXT_STOP 不修改数据

diff 结构（建议）

moved_items[], added_items[], removed_items[]

impact_scope：影响了后续几个点/哪几段

指标

action_preview_to_apply_rate

action_fail_rate_by_code

3.8 LLM（P1）
API

POST /llm/parse-trip（14.1）

输入自然语言 → 输出 DTO 或澄清问题

resp：

{
  "status":"complete|need_clarification",
  "params":{...},
  "questions":[{"field":"start_date","q":"你打算几号出发？"}],
  "provider":"openai|gemini|deepseek|mock"
}


POST /llm/humanize（14.2）

结构化结果 → 自然语言（Explain 的自然语言补强）

POST /llm/decision-support（14.3）

what-if 结果总结与建议

GET /llm/providers（14.5）

当前可用 provider 列表 + 状态

关键要求

provider 不可用时：自动 fallback（但必须在 meta.provider_status 里显式告知前端）

严格 JSON schema 输出（你之前遇到 parse error，建议所有 LLM 输出走 schema 校验 + repair）

指标

llm_parse_success_rate

llm_clarification_rate

llm_json_repair_rate

provider_fallback_rate

3.9 System（P1）
API

GET /system/status（16.1/16.2）

resp：

{
  "modules":{
    "places":{"status":"ok"},
    "transport":{"status":"degraded","reason":"provider_timeout"},
    "llm":{"status":"ok","provider":"deepseek"},
    "vision":{"status":"unavailable"},
    "voice":{"status":"ok"}
  },
  "rate_limits":{...},
  "feature_flags":{...}
}

4) P2 模块规格（先给“最小可实现接口”，你后续迭代细化）
4.1 Decision（P2，核心神经系统）
API

POST /decision/plan（17.1）

输入：State + Constraints + Objective

输出：Schedule + DecisionLog

POST /decision/repair（17.2）

输入：旧 schedule + 新 world_state（天气/闭馆/延误）

输出：最小改动 schedule + changes + explain

POST /decision/validate（17.3）

输出 violations（标准结构）

GET /decision/logs/:id（17.4）

返回可解释证据链：evidence + changes + anchors

日志最小字段（建议你立刻定死）

strategy, trigger, kept_hard_count, dropped_soft_count, change_distance_metric

4.2 Trails（P2）
API

POST /trails/import-gpx

GET /trails/:id

POST /trails/:id/track/start|stop

GET /trails/:id/report

4.3 Hotels / FlightPrices（P2）
API

GET /hotels/estimate?city=...&star=...

GET /hotels/signal?city=...&star=...（红绿灯 + 置信度）

GET /flights/estimate?...

GET /flights/signal?...

强烈建议加：confidence + data_coverage，不够就降级展示（只给历史区间）

4.4 Voice / Vision（P2）

POST /voice/transcribe

POST /voice/parse-intent（输出 action_type + payload）

POST /vision/ocr-poi（候选 places + why）

5) 里程碑交付定义（你可以直接贴到评审里）
Milestone A（P0：能创建→能排→能走）

Trips / Places(关键词+附近) / Items / Transport(T_robust) / OptimizeDay / Actions

必须交付：violations + dropped_items + explain 三件套

Milestone B（P1：好用、可信、可解释）

PlanningPolicy / 语义搜索 / LLM 解析+追问 / System 状态页

Milestone C（P2：护城河）

Decision 三策略 + Repair

Trails 追踪与报告

酒店/机票信号与预测

6) 你下一步怎么用这份文档（不需要你再整理）

直接把 “统一结构件（Violation/Dropped/Explain）” 发给后端/前端，先对齐 schema

后端按 Milestone A 把接口骨架起出来（哪怕 provider 先 mock）

测试用例先围绕：午餐块、T_robust 判定、hard/soft 丢弃、解释锚点