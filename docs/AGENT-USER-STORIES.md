# Agent 模块用户故事 - System 1 vs System 2

## 📖 概述

本文档通过真实的用户故事，说明什么时候使用 **System 1（快速路径）**，什么时候使用 **System 2（慢速路径）**。

---

## 🚀 System 1（快速路径）

**特点**：
- ⚡ **极速响应**：< 3 秒
- 🎯 **单一任务**：明确的 CRUD 或简单查询
- 📊 **高置信度**：≥ 0.75
- 🔒 **低风险**：无需用户授权

### 1. SYSTEM1_API - 标准 API / CRUD 操作

#### 用户故事 1.1：删除行程项
**用户输入**：
```
删除清水寺
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_API`
- ✅ **置信度**: 0.85
- ✅ **原因**: 明确的删除操作，无复杂约束

**执行流程**：
1. 解析实体："清水寺" → Place ID
2. 调用 `trips.remove_item` Action
3. 直接返回结果

**响应时间**: < 500ms  
**用户体验**: 瞬间完成，无需等待

---

#### 用户故事 1.2：添加地点到行程
**用户输入**：
```
添加东京塔到行程
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_API`
- ✅ **置信度**: 0.85
- ✅ **原因**: 明确的添加操作

**执行流程**：
1. 解析实体："东京塔" → Place ID
2. 调用 `trips.add_item` Action
3. 直接返回结果

**响应时间**: < 1s  
**用户体验**: 快速响应，立即看到结果

---

#### 用户故事 1.3：移动行程项
**用户输入**：
```
把浅草寺移到第一天
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_API`
- ✅ **置信度**: 0.85
- ✅ **原因**: 明确的移动操作

**执行流程**：
1. 解析实体："浅草寺" → ItineraryItem ID
2. 调用 `trips.move_item` Action
3. 直接返回结果

**响应时间**: < 1s

---

### 2. SYSTEM1_RAG - 知识库/向量检索

#### 用户故事 2.1：简单推荐查询
**用户输入**：
```
推荐新宿拉面
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_RAG`
- ✅ **置信度**: 0.8
- ✅ **原因**: 单纯事实查询，知识库覆盖

**执行流程**：
1. 使用 `PlacesService.search()` 进行关键词搜索
2. 返回匹配的餐厅列表
3. 生成自然语言回答

**响应时间**: < 2s  
**用户体验**: 快速获得推荐结果

---

#### 用户故事 2.2：查询营业时间
**用户输入**：
```
浅草寺营业时间是什么
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_RAG`
- ✅ **置信度**: 0.8
- ✅ **原因**: 单纯事实查询

**执行流程**：
1. 解析实体："浅草寺" → Place ID
2. 查询 POI 详细信息（营业时间）
3. 返回格式化结果

**响应时间**: < 1s

---

#### 用户故事 2.3：查询价格信息
**用户输入**：
```
东京塔门票多少钱
```

**路由决策**：
- ✅ **路由**: `SYSTEM1_RAG`
- ✅ **置信度**: 0.8
- ✅ **原因**: 单纯事实查询

**执行流程**：
1. 解析实体："东京塔" → Place ID
2. 查询价格信息
3. 返回结果

**响应时间**: < 1s

---

## 🧠 System 2（慢速路径）

**特点**：
- 🐢 **深度分析**：< 60 秒
- 🔄 **ReAct 循环**：Plan → Act → Observe → Critic → Repair
- 🎯 **多步骤推理**：需要多个 Actions 协作
- 🔒 **高风险操作**：可能需要用户授权

### 3. SYSTEM2_REASONING - ReAct + 工具 + TravelPlanner/Critic

#### 用户故事 3.1：多日行程规划
**用户输入**：
```
规划5天东京游，包含浅草寺、东京塔、新宿、原宿、涩谷
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_REASONING`
- ✅ **置信度**: 0.75
- ✅ **原因**: 
  - 规划信号（"规划"、"几天"）
  - 多个地点需要优化排序
  - 需要时间矩阵和 VRPTW 优化

**执行流程**（ReAct 循环）：
1. **Plan**: 选择 `places.resolve_entities` Action
2. **Act**: 解析所有地点实体
3. **Observe**: 获得地点列表和坐标
4. **Plan**: 选择 `places.get_poi_facts` Action
5. **Act**: 获取 POI 详细信息（营业时间、服务时长）
6. **Observe**: 获得完整 POI 数据
7. **Plan**: 选择 `transport.build_time_matrix` Action
8. **Act**: 构建时间矩阵（API + 鲁棒时间）
9. **Observe**: 获得时间矩阵
10. **Plan**: 选择 `itinerary.cluster_days_balanced` Action
11. **Act**: 多日聚类（均衡负载）
12. **Observe**: 获得每日聚类结果
13. **Plan**: 选择 `itinerary.optimize_day_vrptw` Action
14. **Act**: 每日 VRPTW 优化
15. **Observe**: 获得优化后的行程
16. **Critic**: 可行性检查（时间窗、日界、午餐）
17. **Repair**: 如有冲突，调整顺序或时间
18. **Plan**: 选择 `policy.validate_feasibility` Action
19. **Act**: 最终可行性验证
20. **Observe**: 获得验证结果
21. **完成**: 返回完整行程

**响应时间**: 10-30s  
**用户体验**: 显示 "正在深度分析..."，进度可追踪

---

#### 用户故事 3.2：条件分支处理
**用户输入**：
```
如果赶不上日落就改去横滨
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_REASONING`
- ✅ **置信度**: 0.7
- ✅ **原因**: 
  - 条件分支信号（"如果...就"）
  - 需要推理和判断
  - 可能需要时间计算

**执行流程**（ReAct 循环）：
1. **Plan**: 解析条件："赶不上日落" → 需要计算时间
2. **Act**: 调用 `places.resolve_entities` 解析 "日落" 地点
3. **Observe**: 获得日落地点和时间
4. **Act**: 调用 `transport.build_time_matrix` 计算到达时间
5. **Observe**: 获得到达时间
6. **Critic**: 判断是否赶得上
7. **Plan**: 如果赶不上，选择 `trips.replace_item` Action
8. **Act**: 替换为横滨相关地点
9. **Observe**: 获得新的行程
10. **完成**: 返回结果

**响应时间**: 5-15s

---

#### 用户故事 3.3：多约束规划
**用户输入**：
```
规划3天京都游，既要看寺庙又要吃美食，但不要人太多的地方，还要能赶得上日落
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_REASONING`
- ✅ **置信度**: 0.85
- ✅ **原因**: 
  - 多约束信号（"既要...又要...但不要..."）
  - 需要多步骤推理和优化

**执行流程**（ReAct 循环）：
1. **Plan**: 解析约束
   - 硬约束：寺庙、美食、日落
   - 软约束：人少
2. **Act**: 调用 `places.resolve_entities` 解析所有实体
3. **Observe**: 获得地点列表
4. **Act**: 调用 `places.get_poi_facts` 获取详细信息（人流量、类别）
5. **Observe**: 获得 POI 数据
6. **Act**: 调用 `itinerary.optimize_day_vrptw` 优化（考虑人流量约束）
7. **Critic**: 检查是否满足所有约束
8. **Repair**: 如有冲突，调整地点或时间
9. **完成**: 返回满足约束的行程

**响应时间**: 15-40s

---

#### 用户故事 3.4：高风险操作（支付/预订）
**用户输入**：
```
预订这家酒店
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_REASONING`
- ✅ **置信度**: 0.9
- ✅ **原因**: 
  - 高风险操作（"预订"、"支付"）
  - 需要用户授权
  - 需要 dry-run 验证

**执行流程**（ReAct 循环）：
1. **Plan**: 识别需要授权
2. **Act**: 返回 `NEED_CONSENT` 状态
3. **Observe**: 等待用户授权
4. **用户授权后**:
5. **Act**: 调用 `hotels.check_availability` Action（dry-run）
6. **Observe**: 获得可用性和价格
7. **Critic**: 验证价格和政策
8. **Act**: 返回 `NEED_CONFIRMATION` 状态（二次确认）
9. **用户确认后**:
10. **Act**: 执行实际预订
11. **完成**: 返回预订结果

**响应时间**: 取决于用户响应时间  
**用户体验**: 需要授权和确认，确保安全

---

### 4. SYSTEM2_WEBBROWSE - 无头浏览器兜底

#### 用户故事 4.1：官网查询实时信息
**用户输入**：
```
去官网查一下下周六有房吗
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_WEBBROWSE`
- ✅ **置信度**: 0.9
- ✅ **原因**: 
  - 实时/网页信号（"官网"、"下周六"、"有房"）
  - 需要浏览器操作
  - 需要用户授权

**执行流程**（ReAct 循环）：
1. **Plan**: 识别需要浏览器
2. **Act**: 返回 `NEED_CONSENT` 状态
3. **Observe**: 等待用户授权
4. **用户授权后**:
5. **Act**: 启动无头浏览器
6. **Act**: 导航到官网
7. **Act**: 填写查询条件（日期：下周六）
8. **Act**: 提交查询
9. **Observe**: 解析页面结果
10. **Critic**: 验证结果可信度
11. **完成**: 返回可用性信息

**响应时间**: 20-60s（取决于网站响应）  
**用户体验**: 显示 "正在浏览网页..."，需要授权

---

#### 用户故事 4.2：实时价格查询
**用户输入**：
```
查一下今天东京到京都的火车票价格
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_WEBBROWSE`
- ✅ **置信度**: 0.85
- ✅ **原因**: 
  - 实时信号（"今天"、"实时"）
  - 可能需要访问官网

**执行流程**：
1. 先尝试 API 查询（如果有）
2. 如果 API 不可用，使用浏览器
3. 需要用户授权
4. 查询官网价格
5. 返回结果

**响应时间**: 15-45s

---

## 📊 决策流程图

```
用户输入
    ↓
Router 分析
    ↓
┌─────────────────────────────────────┐
│ 硬规则短路检查                        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 支付/退款/浏览器?                    │
│ → SYSTEM2 + consent_required        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 明确 CRUD?                           │
│ → SYSTEM1_API                       │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 单纯事实查询?                        │
│ → SYSTEM1_RAG                       │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 特征提取                             │
│ - 约束数量                            │
│ - 规划信号                            │
│ - 实时/网页信号                       │
│ - 歧义度                              │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 灰区打分                             │
│ - 约束多 → System2                   │
│ - 有规划 → System2                   │
│ - 有实时 → System2_WEBBROWSE         │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 置信度判断                           │
│ - ≥0.75: 直接执行                    │
│ - 0.45-0.75: System1 近似或追问     │
│ - <0.45: 必须追问关键字段            │
└─────────────────────────────────────┘
```

---

## 🎯 快速参考表

| 场景类型 | 示例 | 路由 | 响应时间 | 需要授权 |
|---------|------|------|---------|---------|
| **删除操作** | "删除清水寺" | SYSTEM1_API | < 1s | ❌ |
| **添加操作** | "添加东京塔" | SYSTEM1_API | < 1s | ❌ |
| **移动操作** | "移到第一天" | SYSTEM1_API | < 1s | ❌ |
| **简单推荐** | "推荐新宿拉面" | SYSTEM1_RAG | < 2s | ❌ |
| **事实查询** | "营业时间" | SYSTEM1_RAG | < 1s | ❌ |
| **多日规划** | "规划5天游" | SYSTEM2_REASONING | 10-30s | ❌ |
| **条件分支** | "如果...就" | SYSTEM2_REASONING | 5-15s | ❌ |
| **多约束** | "既要...又要" | SYSTEM2_REASONING | 15-40s | ❌ |
| **支付/预订** | "预订酒店" | SYSTEM2_REASONING | 取决于用户 | ✅ |
| **官网查询** | "官网查房" | SYSTEM2_WEBBROWSE | 20-60s | ✅ |
| **实时信息** | "今天价格" | SYSTEM2_WEBBROWSE | 15-45s | ✅ |

---

## 💡 设计原则

### System 1 使用原则
1. **单一明确任务**：用户意图清晰，无需推理
2. **已有 API 覆盖**：可以直接调用现有服务
3. **低风险操作**：不会造成数据丢失或财务损失
4. **快速响应**：用户期望立即看到结果

### System 2 使用原则
1. **需要多步推理**：需要多个 Actions 协作
2. **复杂约束**：多个条件需要同时满足
3. **需要优化**：需要算法优化（VRPTW、聚类）
4. **高风险操作**：涉及支付、预订、浏览器操作
5. **实时信息**：需要访问外部网站获取最新信息

---

## 🔍 边界案例

### 案例 1：模糊查询
**用户输入**：
```
推荐一些地方
```

**路由决策**：
- ⚠️ **路由**: `SYSTEM1_RAG`（降级）
- ⚠️ **置信度**: 0.4（低）
- ⚠️ **原因**: 信息不足

**执行流程**：
1. 返回 `NEED_MORE_INFO` 状态
2. 追问："您想去哪个城市？"

---

### 案例 2：混合操作
**用户输入**：
```
删除清水寺，然后规划新的行程
```

**路由决策**：
- ✅ **路由**: `SYSTEM2_REASONING`
- ✅ **置信度**: 0.7
- ✅ **原因**: 包含规划信号

**执行流程**：
1. 先执行删除（System1 操作）
2. 然后进入 System2 规划流程

---

## 📚 总结

- **System 1**：80-90% 的高频任务，快速响应，用户无感知
- **System 2**：10-20% 的高价值场景，深度分析，用户可追踪进度

通过智能路由，我们实现了：
- ⚡ **快速响应**：简单任务秒级完成
- 🧠 **深度分析**：复杂任务得到最优解
- 🔒 **安全保障**：高风险操作需要授权
- 📊 **可观测性**：所有决策可追踪、可解释

