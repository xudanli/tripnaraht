generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

model Place {
  id               Int                       @id @default(autoincrement())
  uuid             String                    @unique @default(uuid())
  name             String
  nameEN           String?
  category         PlaceCategory
  location         Unsupported("geography")?
  address          String?
  cityId           Int?
  metadata         Json?
  physicalMetadata Json?
  googlePlaceId    String?                   @unique
  rating           Float?                    @default(0)
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  itineraryItems   ItineraryItem[]
  city             City?                     @relation(fields: [cityId], references: [id])

  @@index([metadata(ops: JsonbPathOps)], type: Gin)
}

model Trip {
  id           String    @id @default(uuid())
  destination  String
  startDate    DateTime
  endDate      DateTime
  budgetConfig Json?
  pacingConfig Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  days         TripDay[]
}

model TripDay {
  id     String          @id @default(uuid())
  date   DateTime
  tripId String
  items  ItineraryItem[]
  trip   Trip            @relation(fields: [tripId], references: [id])
}

model ItineraryItem {
  id        String    @id @default(uuid())
  startTime DateTime?
  endTime   DateTime?
  type      ItemType
  placeId   Int?
  tripDayId String
  note      String?
  place     Place?    @relation(fields: [placeId], references: [id])
  tripDay   TripDay   @relation(fields: [tripDayId], references: [id])
}

model City {
  id          Int     @id @default(autoincrement())
  name        String
  countryCode String
  places      Place[]
}

model CountryProfile {
  isoCode           String       @id @unique
  nameCN            String
  powerInfo         Json?
  emergency         Json?
  paymentInfo       Json?
  visaForCN         Json?
  flightEstimates   Json?
  updatedAt         DateTime     @updatedAt
  currencyCode      String?
  currencyName      String?
  exchangeRateToCNY Float?
  paymentType       PaymentType?
}

model FlightPriceReference {
  id              Int      @id @default(autoincrement())
  countryCode     String   @db.VarChar(2)
  originCity      String?  @db.VarChar(10)
  lowSeasonPrice  Int
  highSeasonPrice Int
  averagePrice    Int
  visaCost        Int      @default(0)
  source          String?  @db.VarChar(255)
  lastUpdated     DateTime @default(now()) @db.Timestamp(6)
  notes           String?
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamp(6)

  @@index([countryCode])
  @@index([countryCode, originCity])
}

/// This table has subclasses and requires additional setup for migrations. Visit https://pris.ly/d/table-inheritance for more info.
/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model postgres_log {
  log_time               DateTime? @db.Timestamptz(3)
  user_name              String?
  database_name          String?
  process_id             Int?
  connection_from        String?
  session_id             String
  session_line_num       BigInt
  command_tag            String?
  session_start_time     DateTime? @db.Timestamptz(6)
  virtual_transaction_id String?
  transaction_id         BigInt?
  error_severity         String?
  sql_state_code         String?
  message                String?
  detail                 String?
  hint                   String?
  internal_query         String?
  internal_query_pos     Int?
  context                String?
  query                  String?
  query_pos              Int?
  location               String?
  application_name       String?
  backend_type           String?
  leader_pid             Int?
  query_id               BigInt?

  @@ignore
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum PlaceCategory {
  ATTRACTION
  RESTAURANT
  SHOPPING
  HOTEL
  TRANSIT_HUB
}

enum ItemType {
  ACTIVITY
  REST
  MEAL_ANCHOR
  MEAL_FLOATING
  TRANSIT
}

enum PaymentType {
  CASH_HEAVY
  BALANCED
  DIGITAL_ONLY
}

// --------------------------------------
// ✈️ 国内航线价格详细表 (基于历史数据)
// --------------------------------------
model FlightPriceDetail {
  id Int @id @default(autoincrement())

  // 航线标识符（出发城市->到达城市）
  routeId String // "成都->深圳"

  // 出发城市
  originCity String // "成都"

  // 到达城市
  destinationCity String // "深圳"

  // 起飞机场信息
  originAirport          String? // "成都双流国际机场"
  originAirportLongitude Float? // 机场经度
  originAirportLatitude  Float? // 机场纬度

  // 降落机场信息
  destinationAirport          String? // "深圳宝安国际机场"
  destinationAirportLongitude Float? // 机场经度
  destinationAirportLatitude  Float? // 机场纬度

  // 月份（1-12）
  month Int

  // 星期几（0=周一, 6=周日）
  dayOfWeek Int?

  // 月度基准价（该航线在该月的平均价格）
  monthlyBasePrice Float // P_month

  // 周内因子（该星期几相对于总平均价的倍数）
  dayOfWeekFactor Float? // F_day

  // 统计信息
  sampleCount Int    @default(0) // 样本数量
  minPrice    Float? // 最低价格
  maxPrice    Float? // 最高价格
  stdDev      Float? // 标准差

  // 数据来源
  source      String?  @default("2024年历史数据")
  lastUpdated DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 唯一约束：同一航线、月份、星期几只能有一条记录
  @@unique([routeId, month, dayOfWeek])
  // 索引：按航线、月份、星期几查询
  @@index([routeId, month])
  @@index([routeId, month, dayOfWeek])
  @@index([originCity, destinationCity])
}

// --------------------------------------
// ✈️ 周内因子查找表（全局因子）
// --------------------------------------
model DayOfWeekFactor {
  id Int @id @default(autoincrement())

  // 星期几（0=周一, 6=周日）
  dayOfWeek Int @unique

  // 周内因子（相对于总平均价的倍数）
  factor Float // F_day

  // 统计信息
  sampleCount   Int    @default(0)
  avgPrice      Float? // 该星期几的平均价格
  totalAvgPrice Float? // 总平均价格

  lastUpdated DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
