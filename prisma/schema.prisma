generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

model City {
  id          Int                       @id @default(autoincrement())
  name        String
  countryCode String
  adcode      String?
  nameCN      String?
  nameEN      String?
  location    Unsupported("geography")?
  timezone    String?
  metadata    Json?
  Place       Place[]

  @@index([countryCode])
  @@index([nameCN])
  @@index([nameEN])
  @@index([name])
}

model CountryProfile {
  isoCode           String       @id @unique
  nameCN            String
  powerInfo         Json?
  emergency         Json?
  paymentInfo       Json?
  visaForCN         Json?
  updatedAt         DateTime
  currencyCode      String?
  currencyName      String?
  exchangeRateToCNY Float?
  paymentType       PaymentType?
  exchangeRateToUSD Float?
  nameEN            String?
}

model DayOfWeekFactor {
  id            Int      @id @default(autoincrement())
  dayOfWeek     Int      @unique
  factor        Float
  sampleCount   Int      @default(0)
  avgPrice      Float?
  totalAvgPrice Float?
  lastUpdated   DateTime @default(now())
  updatedAt     DateTime
}

model FlightPriceDetail {
  id                          Int      @id @default(autoincrement())
  routeId                     String
  originCity                  String
  destinationCity             String
  month                       Int
  dayOfWeek                   Int?
  monthlyBasePrice            Float
  dayOfWeekFactor             Float?
  sampleCount                 Int      @default(0)
  minPrice                    Float?
  maxPrice                    Float?
  stdDev                      Float?
  source                      String?  @default("2023-2024年历史数据")
  lastUpdated                 DateTime @default(now())
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime
  destinationAirport          String?
  destinationAirportLatitude  Float?
  destinationAirportLongitude Float?
  originAirport               String?
  originAirportLatitude       Float?
  originAirportLongitude      Float?
  airlineCount                Int?     @default(0)
  arrivalTime                 String?
  departureTime               String?
  distanceKm                  Float?
  isWeekend                   Boolean? @default(false)
  monthFactor                 Float?
  timeOfDayFactor             Float?

  @@unique([routeId, month, dayOfWeek])
  @@index([originCity, destinationCity])
  @@index([routeId, month, dayOfWeek])
  @@index([routeId, month])
}

model FlightPriceReference {
  id              Int      @id @default(autoincrement())
  countryCode     String   @db.VarChar(2)
  originCity      String?  @db.VarChar(10)
  lowSeasonPrice  Int
  highSeasonPrice Int
  averagePrice    Int
  visaCost        Int      @default(0)
  source          String?  @db.VarChar(255)
  lastUpdated     DateTime @default(now()) @db.Timestamp(6)
  notes           String?
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @default(now()) @db.Timestamp(6)

  @@index([countryCode])
  @@index([countryCode, originCity])
}

model HotelPriceDetail {
  city        String   @id
  avgPrice    Float?
  medianPrice Float?
  cityFactor  Float?
  sampleCount Int      @default(0)
  minPrice    Float?
  maxPrice    Float?
  stdDev      Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@index([city])
}

model HotelWideData_Quarterly {
  id         Int     @id @default(autoincrement())
  city       String?
  starRating Int?
  Q1         Float?  @map("2018_Q1")
  Q2         Float?  @map("2018_Q2")
  Q3         Float?  @map("2018_Q3")
  Q4         Float?  @map("2018_Q4")
  Q1         Float?  @map("2019_Q1")
  Q2         Float?  @map("2019_Q2")
  Q3         Float?  @map("2019_Q3")
  Q4         Float?  @map("2019_Q4")
  Q1         Float?  @map("2020_Q1")
  Q2         Float?  @map("2020_Q2")
  Q3         Float?  @map("2020_Q3")
  Q4         Float?  @map("2020_Q4")
  Q1         Float?  @map("2021_Q1")
  Q2         Float?  @map("2021_Q2")
  Q3         Float?  @map("2021_Q3")
  Q4         Float?  @map("2021_Q4")
  Q1         Float?  @map("2022_Q1")
  Q2         Float?  @map("2022_Q2")
  Q3         Float?  @map("2022_Q3")
  Q4         Float?  @map("2022_Q4")
  Q1         Float?  @map("2023_Q1")
  Q2         Float?  @map("2023_Q2")
  Q3         Float?  @map("2023_Q3")
  Q4         Float?  @map("2023_Q4")
  Q1         Float?  @map("2024_Q1")

  @@index([city])
  @@index([city, starRating])
  @@index([starRating])
}

model ItineraryItem {
  id          String       @id
  startTime   DateTime?
  endTime     DateTime?
  type        ItemType
  placeId     Int?
  tripDayId   String
  note        String?
  trailId     Int?
  Place       Place?       @relation(fields: [placeId], references: [id])
  Trail       Trail?       @relation(fields: [trailId], references: [id])
  TripDay     TripDay      @relation(fields: [tripDayId], references: [id])
  RailSegment RailSegment?
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Place {
  id                              Int                       @id @default(autoincrement())
  uuid                            String                    @unique
  nameEN                          String?
  category                        PlaceCategory
  location                        Unsupported("geography")?
  address                         String?
  cityId                          Int?
  metadata                        Json?
  physicalMetadata                Json?
  googlePlaceId                   String?                   @unique
  rating                          Float?                    @default(0)
  createdAt                       DateTime                  @default(now())
  updatedAt                       DateTime
  nameCN                          String
  embedding                       Unsupported("vector")?
  ItineraryItem                   ItineraryItem[]
  City                            City?                     @relation(fields: [cityId], references: [id])
  Trail_Trail_endPlaceIdToPlace   Trail[]                   @relation("Trail_endPlaceIdToPlace")
  Trail_Trail_startPlaceIdToPlace Trail[]                   @relation("Trail_startPlaceIdToPlace")
  TrailWaypoint                   TrailWaypoint[]

  @@index([metadata(ops: JsonbPathOps)], type: Gin)
}

model RailPassProfile {
  id                      String            @id
  tripId                  String            @unique
  residencyCountry        String
  passFamily              String
  passType                String
  validityType            String
  travelDaysTotal         Int?
  homeCountryOutboundUsed Int               @default(0)
  homeCountryInboundUsed  Int               @default(0)
  class                   String
  mobileOrPaper           String
  validityStartDate       DateTime
  validityEndDate         DateTime
  createdAt               DateTime          @default(now())
  updatedAt               DateTime
  Trip                    Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)
  RailSegment             RailSegment[]
  ReservationTask         ReservationTask[]

  @@index([tripId])
}

model RailSegment {
  id                  String            @id
  railPassProfileId   String
  itineraryItemId     String?           @unique
  fromPlaceId         Int
  toPlaceId           Int
  fromCountryCode     String
  toCountryCode       String
  departureDate       DateTime
  departureTimeWindow Json?
  arrivalDeadline     DateTime?
  operatorHint        String?
  isNightTrain        Boolean           @default(false)
  isHighSpeed         Boolean           @default(false)
  isInternational     Boolean           @default(false)
  crossesMidnight     Boolean           @default(false)
  t_api               Int?
  t_robust            Int?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime
  ItineraryItem       ItineraryItem?    @relation(fields: [itineraryItemId], references: [id])
  RailPassProfile     RailPassProfile   @relation(fields: [railPassProfileId], references: [id], onDelete: Cascade)
  ReservationTask     ReservationTask[]

  @@index([departureDate])
  @@index([itineraryItemId])
  @@index([railPassProfileId])
}

model RawAttractionData {
  id             Int      @id @default(autoincrement())
  name           String
  level          String?
  address        String?
  province       String?
  publishDate    String?
  documentUrl    String?
  encodedAddress String?
  lng            Float?
  lat            Float?
  importedAt     DateTime @default(now())
  processed      Boolean  @default(false)

  @@index([level])
  @@index([processed])
  @@index([province])
  @@index([province, level])
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model RawFlightData {
  y Decimal? @map("起飞机场y") @db.Decimal
  x Decimal? @map("起飞机场x") @db.Decimal
  y Decimal? @map("降落机场y") @db.Decimal
  x Decimal? @map("降落机场x") @db.Decimal

  @@ignore
}

model RawHotelData_Slim {
  id       String  @id
  name     String?
  brand    String?
  address  String?
  city     String?
  district String?
  lat      Float?
  lng      Float?
  phone    String?
  type     String?
  adcode   String?

  @@index([brand])
  @@index([city, brand])
  @@index([city, district])
  @@index([city])
}

model RawTrainStationData {
  id            Int      @id @default(autoincrement())
  name          String
  address       String?
  railwayBureau String?
  category      String?
  nature        String?
  province      String?
  city          String?
  wgs84Lng      Float?
  wgs84Lat      Float?
  importedAt    DateTime @default(now())
  processed     Boolean  @default(false)

  @@index([city])
  @@index([nature])
  @@index([processed])
  @@index([province, city])
  @@index([province])
  @@index([railwayBureau])
}

model ReadinessPack {
  id             String   @id
  packId         String   @unique
  destinationId  String
  displayName    String
  version        String
  lastReviewedAt DateTime
  countryCode    String
  region         String?
  city           String?
  latitude       Float?
  longitude      Float?
  packData       Json
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@index([countryCode])
  @@index([countryCode, isActive])
  @@index([destinationId])
  @@index([isActive])
  @@index([packId])
}

model ReservationTask {
  id                String          @id
  segmentId         String
  railPassProfileId String
  status            String
  bookingRef        String?
  cost              Float?
  failReason        String?
  fallbackPlanId    String?
  travelDay         DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  RailPassProfile   RailPassProfile @relation(fields: [railPassProfileId], references: [id], onDelete: Cascade)
  RailSegment       RailSegment     @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@index([railPassProfileId])
  @@index([segmentId])
  @@index([status])
  @@index([travelDay])
}

model RouteDirection {
  id                Int                       @id @default(autoincrement())
  uuid              String
  countryCode       String
  name              String
  nameCN            String
  nameEN            String?
  description       String?
  tags              String[]
  corridorGeom      Unsupported("geography")?
  regions           String[]
  entryHubs         String[]
  seasonality       Json?
  constraints       Json?
  riskProfile       Json?
  signaturePois     Json?
  itinerarySkeleton Json?
  metadata          Json?
  isActive          Boolean                   @default(true)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime
  status            String?                   @default("active")
  version           String?
  rolloutPercent    Int?                      @default(100)
  audienceFilter    Json?

  @@index([status], map: "route_direction_status_idx")
}

model StarCityPriceDetail {
  city           String
  starRating     Int
  avgPrice       Float?
  cityStarFactor Float?
  sampleCount    Int      @default(0)
  minPrice       Float?
  maxPrice       Float?
  stdDev         Float?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now())

  @@id([city, starRating])
  @@index([city])
  @@index([city, starRating])
  @@index([starRating])
}

model Trail {
  id                              Int             @id @default(autoincrement())
  uuid                            String          @unique
  nameCN                          String
  nameEN                          String?
  description                     String?
  distanceKm                      Float?
  elevationGainM                  Float?
  elevationLossM                  Float?
  maxElevationM                   Float?
  minElevationM                   Float?
  averageSlope                    Float?
  difficultyLevel                 String?
  equivalentDistanceKm            Float?
  fatigueScore                    Float?
  gpxData                         Json?
  gpxFileUrl                      String?
  bounds                          Json?
  startPlaceId                    Int?
  endPlaceId                      Int?
  metadata                        Json?
  source                          String?
  sourceUrl                       String?
  rating                          Float?
  estimatedDurationHours          Float?
  createdAt                       DateTime        @default(now())
  updatedAt                       DateTime
  ItineraryItem                   ItineraryItem[]
  Place_Trail_endPlaceIdToPlace   Place?          @relation("Trail_endPlaceIdToPlace", fields: [endPlaceId], references: [id])
  Place_Trail_startPlaceIdToPlace Place?          @relation("Trail_startPlaceIdToPlace", fields: [startPlaceId], references: [id])
  TrailWaypoint                   TrailWaypoint[]

  @@index([difficultyLevel])
  @@index([endPlaceId])
  @@index([source])
  @@index([startPlaceId])
}

model TrailWaypoint {
  id      Int     @id @default(autoincrement())
  trailId Int
  placeId Int
  order   Int
  note    String?
  Place   Place   @relation(fields: [placeId], references: [id])
  Trail   Trail   @relation(fields: [trailId], references: [id], onDelete: Cascade)

  @@unique([trailId, placeId])
  @@index([placeId])
  @@index([trailId])
}

model Trip {
  id               String             @id
  destination      String
  startDate        DateTime
  endDate          DateTime
  budgetConfig     Json?
  pacingConfig     Json?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  metadata         Json?
  RailPassProfile  RailPassProfile?
  TripCollaborator TripCollaborator[]
  TripCollection   TripCollection[]
  TripDay          TripDay[]
  TripLike         TripLike[]
  TripShare        TripShare[]
}

model TripCollaborator {
  id        String   @id
  tripId    String
  userId    String
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime
  Trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model TripCollection {
  id        String   @id
  tripId    String
  userId    String
  createdAt DateTime @default(now())
  Trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model TripDay {
  id            String          @id
  date          DateTime
  tripId        String
  ItineraryItem ItineraryItem[]
  Trip          Trip            @relation(fields: [tripId], references: [id])
}

model TripLike {
  id        String   @id
  tripId    String
  userId    String
  createdAt DateTime @default(now())
  Trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model TripOfflinePack {
  id        String   @id
  tripId    String   @unique
  data      Json
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([tripId])
}

model TripShare {
  id         String    @id
  tripId     String
  shareToken String    @unique
  permission String    @default("VIEW")
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Trip       Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([tripId])
}

model TripTemplate {
  id          String   @id
  name        String
  nameCN      String?
  description String?
  theme       String
  destination String?
  config      Json
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([destination])
  @@index([isPublic])
  @@index([theme])
}

model UserProfile {
  userId      String   @id
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([userId])
}

model geo_airlines {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_coastlines {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_country {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model geo_dem_cities_merged {
  rid      Int?
  rast     Unsupported("raster")?
  filename String?

  @@index([filename])
  @@ignore
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model geo_dem_global {
  rid      Int                    @id @default(autoincrement())
  rast     Unsupported("raster")?
  filename String?
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model geo_dem_global_tid {
  rid      Int                    @id @default(autoincrement())
  rast     Unsupported("raster")?
  filename String?
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model geo_dem_xizang {
  rid      Int                    @id @default(autoincrement())
  rast     Unsupported("raster")?
  filename String?
}

model geo_mountains_standard {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_mountains_standard_300 {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_ports {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_railways {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_rivers_line {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_roads {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

model geo_water_poly {
  gid        Int                      @id @default(autoincrement())
  geom       Unsupported("geometry")?
  properties Json?

  @@index([geom], type: Gist)
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model poi_canonical {
  poi_id        String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source        String                   @default("OSM") @db.VarChar(50)
  source_key    String                   @db.VarChar(100)
  name_default  String?                  @db.VarChar(500)
  name_i18n     Json?
  category      String                   @db.VarChar(50)
  lat           Float
  lng           Float
  geom          Unsupported("geometry")?
  address       String?
  opening_hours String?                  @db.VarChar(200)
  phone         String?                  @db.VarChar(50)
  website       String?                  @db.VarChar(500)
  tags_slim     Json?
  fetched_at    DateTime?                @default(now()) @db.Timestamp(6)
  created_at    DateTime?                @default(now()) @db.Timestamp(6)
  updated_at    DateTime?                @default(now()) @db.Timestamp(6)
  region_key    String?                  @db.VarChar(50)
  region_name   String?                  @db.VarChar(100)
  region_center Json?
  altitude_hint Int?

  @@unique([source, source_key])
  @@index([category])
  @@index([geom], type: Gist)
  @@index([region_key])
  @@index([tags_slim], type: Gin)
}

model poi_osm_raw {
  id            Int                      @id @default(autoincrement())
  osm_type      String                   @db.VarChar(10)
  osm_id        BigInt
  geom          Unsupported("geometry")?
  tags          Json
  version       Int?
  timestamp     DateTime?                @db.Timestamp(6)
  created_at    DateTime?                @default(now()) @db.Timestamp(6)
  region_key    String?                  @db.VarChar(50)
  region_name   String?                  @db.VarChar(100)
  region_center Json?

  @@unique([osm_type, osm_id])
  @@index([geom], type: Gist)
  @@index([region_key])
  @@index([tags], type: Gin)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model postgres_log {
  log_time               DateTime? @db.Timestamptz(3)
  user_name              String?
  database_name          String?
  process_id             Int?
  connection_from        String?
  session_id             String
  session_line_num       BigInt
  command_tag            String?
  session_start_time     DateTime? @db.Timestamptz(6)
  virtual_transaction_id String?
  transaction_id         BigInt?
  error_severity         String?
  sql_state_code         String?
  message                String?
  detail                 String?
  hint                   String?
  internal_query         String?
  internal_query_pos     Int?
  context                String?
  query                  String?
  query_pos              Int?
  location               String?
  application_name       String?
  backend_type           String?
  leader_pid             Int?
  query_id               BigInt?

  @@ignore
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum ItemType {
  ACTIVITY
  REST
  MEAL_ANCHOR
  MEAL_FLOATING
  TRANSIT
}

enum PaymentType {
  CASH_HEAVY
  BALANCED
  DIGITAL_ONLY
}

enum PlaceCategory {
  ATTRACTION
  RESTAURANT
  SHOPPING
  HOTEL
  TRANSIT_HUB
}
