// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // å¼€å¯æ‰©å±•æ”¯æŒ
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis] // å£°æ˜ä½¿ç”¨ PostGIS
}

// --------------------------------------
// ğŸŒ æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼šåœ°ç‚¹ (é¤å…/æ™¯ç‚¹)
// --------------------------------------
model Place {
  id        Int      @id @default(autoincrement())
  uuid      String   @default(uuid()) @unique
  
  name      String   // é»˜è®¤åç§° (é€šå¸¸å­˜ä¸­æ–‡)
  nameEN    String?  // è‹±æ–‡åç§° (å¯é€‰)
  category  PlaceCategory // æšä¸¾ï¼šæ™¯ç‚¹ã€é¤å…ç­‰
  
  // ğŸ“ åœ°ç†ä½ç½® (PostGIS)
  // æ³¨æ„ï¼šPrisma ç›®å‰ç”¨ Unsupported å¤„ç†åŸç”Ÿ GIS ç±»å‹
  location  Unsupported("geography(Point, 4326)")? 
  
  address   String?
  
  // ğŸ”— å…³è”
  cityId    Int?
  city      City?    @relation(fields: [cityId], references: [id])

  // ğŸ’ æ ¸å¿ƒçµæ´»å­—æ®µ (JSONB)
  // åŒ…å«ï¼šè¥ä¸šæ—¶é—´ã€è®¾æ–½(æ— éšœç¢)ã€ç©¿è¡£æŒ‡å—ã€é¤é¥®é”šç‚¹å±æ€§
  metadata  Json?    @db.JsonB 
  
  // ğŸ¥µ ä½“åŠ›æ¶ˆè€—å…ƒæ•°æ® (æ–°å¢)
  // { "terrain": "STAIRS_ONLY", "fatigue_score": "HIGH" }
  physicalMetadata Json? @db.JsonB

  googlePlaceId String? @unique 
  rating        Float?  @default(0)

  itineraryItems ItineraryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç´¢å¼•
  @@index([metadata(ops: JsonbPathOps)], type: Gin)
}

// --------------------------------------
// ğŸ—ºï¸ è¡Œç¨‹æ¨¡å‹
// --------------------------------------
model Trip {
  id          String   @id @default(uuid())
  destination String   // ISO Code, e.g. "JP"
  
  startDate   DateTime
  endDate     DateTime
  
  // ğŸ’° é¢„ç®—é…ç½®
  budgetConfig Json?   
  // { "total": 20000, "currency": "CNY", "hotel_tier": "4-Star" }

  // ğŸ”‹ ä½“èƒ½/æœ¨æ¡¶é…ç½® (æ–°å¢)
  // { "pacing_factor": "LOW", "daily_step_limit": 10000, "forced_rest_interval": 90 }
  pacingConfig Json?   

  days        TripDay[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TripDay {
  id     String @id @default(uuid())
  date   DateTime
  tripId String
  trip   Trip   @relation(fields: [tripId], references: [id])
  
  items  ItineraryItem[]
}

model ItineraryItem {
  id        String   @id @default(uuid())
  startTime DateTime?
  endTime   DateTime?
  
  type      ItemType // ACTIVITY, REST, MEAL, TRANSIT
  
  placeId   Int?
  place     Place?   @relation(fields: [placeId], references: [id])
  
  tripDayId String
  tripDay   TripDay  @relation(fields: [tripDayId], references: [id])
  
  note      String?
}

// --------------------------------------
// ğŸ³ï¸ å›½å®¶/åŸå¸‚æ¡£æ¡ˆ
// --------------------------------------
model City {
  id      Int     @id @default(autoincrement())
  name    String
  countryCode String
  places  Place[]
}

model CountryProfile {
  isoCode     String @id @unique // "JP"
  nameCN      String
  
  // ğŸ’± è´§å¸ä¿¡æ¯
  currencyCode String? // "JPY"
  currencyName String? // "Yen"
  
  // ğŸ’³ æ”¯ä»˜ç”»åƒ (å…³é”®å­—æ®µ)
  paymentType  PaymentType? // æšä¸¾: CASH_HEAVY, BALANCED, DIGITAL_ONLY
  
  // ğŸ“ æ”¯ä»˜å®ç”¨å»ºè®® (JSONB)
  // å­˜: {"tipping": "No tipping", "atm_network": "7-Bank is best", "wallet_apps": ["Suica", "PayPay"], "cash_preparation": "ç¡¬å¸ä½¿ç”¨æé«˜ï¼ŒåŠ¡å¿…å‡†å¤‡é›¶é’±è¢‹"}
  paymentInfo Json? @db.JsonB
  
  // ğŸ’± æ±‡ç‡ (ç¼“å­˜å€¼ï¼Œæ¯å¤©æ›´æ–°ä¸€æ¬¡)
  // 1 å¤–å¸ = å¤šå°‘ CNYï¼Œä¾‹å¦‚ 0.048 (1 JPY = 0.048 CNY)
  exchangeRateToCNY Float?
  
  // ğŸ”Œ ç”µå‹ã€æ’åº§
  powerInfo   Json? 
  // ğŸš‘ ç´§æ€¥ç”µè¯
  emergency   Json?
  // ğŸ›‚ ç­¾è¯æ”¿ç­–
  visaForCN   Json? 
  // âœˆï¸ æœºç¥¨ä¼°ç®—
  flightEstimates Json?

  updatedAt   DateTime @updatedAt
}

// --------------------------------------
// âš™ï¸ æšä¸¾
// --------------------------------------
enum PlaceCategory {
  ATTRACTION
  RESTAURANT
  SHOPPING
  HOTEL
  TRANSIT_HUB
}

enum ItemType {
  ACTIVITY
  REST
  MEAL_ANCHOR
  MEAL_FLOATING
  TRANSIT
}

enum PaymentType {
  CASH_HEAVY   // å¿…é¡»å¸¦å¤§é‡ç°é‡‘ï¼ˆæ—¥æœ¬ã€å¾·å›½ã€å¤§éƒ¨åˆ†ä¸œå—äºšï¼‰
  BALANCED     // å¡+ç°é‡‘æ··åˆï¼ˆç¾å›½ã€æ³•å›½ã€å¤§éƒ¨åˆ†æ¬§æ´²ï¼‰
  DIGITAL_ONLY // åŸºæœ¬ä¸ç”¨ç°é‡‘ï¼ˆä¸­å›½ã€ç‘å…¸ã€æ–°åŠ å¡ã€è‹±å›½ä¼¦æ•¦ï¼‰
}